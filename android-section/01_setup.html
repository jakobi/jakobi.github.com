<HTML>
<HEAD>
<link rel="icon"          href="/favicon.png"/>
<link rel="shortcut icon" href="/favicon.png"/>
<meta name="description" content="Coping with Android - Setup as a Unix Box: survival unix shell chroot debian ubuntu google android tutorial samsung galaxy note vnc X11 xvnc bash office arm armel jailbreak root rooting">
<meta name="keywords" content="coping android setup as unix box survival shell chroot debian ubuntu google tutorial samsung galaxy note vnc xvnc bash office arm armel jailbreak root rooting">
<meta name="author" content="Peter Jakobi">
<TITLE>Coping with Android - Setup as a Unix Box</TITLE>
<style type="text/css"><!--
   .anno { font-size:.8em }
   pre { background-color:#eeeeee }
--></style>
<style type="text/css"><!--
   .num { padding-left:1em; text-align:right; nopadding-right:1em}
   .repo{ text-align:center}
   .file{ nopadding-left:1em; font-family:monospace}
.desc{ padding-left:2em}
--></style>
</HEAD>

<BODY style="background-color:#ffffee">

<p class=anno>
<a href="http://jakobi.github.com/">HOME</a>                                          &nbsp;|&nbsp; 
<a href="http://github.com/jakobi/">GIT Overview</a>          &nbsp;|&nbsp;
Script-Archive:
<a href="/script-archive-doc/">(docs)</a> : 
<a href="http://wiki.github.com/jakobi/script-archive/">(wiki)</a> : 
<a href="http://github.com/jakobi/script-archive">(git)</a>    &nbsp;|&nbsp;
Android:
<a href="http://jakobi.github.com/android-section/">(articles)</a> :
<a href="http://github.com/jakobi/script-archive/tree/master/android">(files)</a> &nbsp;|&nbsp;
...
</p>

<H1>Coping with Android - Setup as a Unix Box</H1>

<hr>

<p>Also                  see                  the                   <a href="http://github.com/jakobi/script-archive/tree/master/android">Android
directory  of  the  script-archive</a>.</p>

<p>Besides some scripts, this directory contains a mothballed snapshot
of  my working Android environment intended to complement the articles
below (android-setup-example-files.tgz).</p>

<p>In  it  you  find the scripts for the Android  shell,  a
collection  of static armel binaries, the tree structure of the chroot
on  the  Galaxy note, as well as scripts and configuration files  used
for monitoring, backup, etc from a remote Linux server via cron.</p>

<p class=anno>Last changes: <BR>20120222 abin/CHECK + CHROOT.mount, system/xbin/CHROOT.umount</p>

<p>Current  versions of the more interesting scripts will be placed in
above   directory   (if   Android-specific)  or   elsewhere   in   the
script-archive (parts of my bash/ksh setup or generic Unix stuff).</p>



<hr>
<h2>01 - Setting  up  the Samsung Galaxy Note as a Unix  Box</H2>

<p  class=anno><i>(or  at  least as much as we can get away  with,  given
Google's  Linux kernel  patches and dumbed-down kernel configuration)</i></p>

<H3>Table of contents</H3>
<a name=toc></a>
<ul>
<li><a href="#firstlook">A first look at the Note / Web-Resources / Rooting</a>
<li><a href="#shell">Adding Unix Standards to the Android Shell</a>
<li><a href="#chroot">CHROOT and Turning the Android into a First Class LAN Citizen</a>
<li><a href="#vnc">Desktop and X11</a>
</ul>

<p>For       alternative       native       setups       like       <a href="http://www.nslu2-linux.org/wiki/Optware/HomePage">OPTWARE</a> of
NSLU2   fame,  see  <a href="01b_setup_alternatives.html">1b   Setup
Alternatives</a>.  It's  a  good  companion  /  alternative  to  using
TERMINAL  IDE  for a somewhat sane native environment in  the  android
shell.</p>

<p>
State described: Android 2.3.6 (gingerbread)<BR>
Last change: 20120309<BR>
License: CC-BY-SA.
</p>

<p>Most  of the article should also hold for other recent  gingerbread
devices,  the  generics also for all newer Android devices. When  I've
installed  ICS  on the Note (middle 2012 I'd assume), I will  add  ICS
errata at the end of each part.</p>



<hr>
<a name=firstlook></a>
<H3>A first look at the Note / Web-Resources / Rooting</H3>

<p>This  article  sketches  a sane setup of GNU/Linux on  an  ordinary
<B>1-GB-RAM   DUAL-CORE  PC</B>  (henceforth  called   the   armel
architecture  Android device <b>Samsung Galaxy Note</b> GT-N7000).

<p>This hardware is more than enough for a moderate desktop PC that is
not  used  for heavy gaming, virtualization or video editing. In  this
article,   I'm   not  interested  in  audio/video   input/output   nor
phone/s-pen/sensor/camera use.</p>

<p>Web Resources of interest:</p>
<ul>
<li><a href="http://www.androidnz.net/2011/12/samsung-galaxy-note-complete-review.html">AndroidNZ review with some app suggestions</a>
<li><a href="http://forum.xda-developers.com/forumdisplay.php?f=1349">XDA Note forum</a>
</ul>


<p>I/O options of the Note include</p>
<ul>
<li>the OTG USB port, which permits to connect
<ul>
<li>the Note to the PC (adb, access to 
    the Note's FAT user filesystems) or
<li>some external USB hardware
    to the Note (mouse/keyboard/memory stick, etc, as long as an in-kernel
    driver is available)
<li>the HDMI connection cable (reusing the physical OTG port)
</ul>
<li>acting as either a WLAN-client or a WLAN Access Point
<li>networking over USB
<li>the S-pen - a real wacom-style stylus offering pressure-sensitivity
    and high resolution (not one of the iphone-style capacitive 
    finger-tip-replacements; better quality tablet-PC pens do work
    on the Note offering both eraser and stylus)
<li>...
</ul>


<p>Flash  considerations: Choose a <i>quality</i> sdhc microsd  flash,
with  a size of 16 or 32GB. Read speeds for the internal flash are 50+
MB/s  and  18MB/s  for the external (as measured with  hdparm  for  my
Sandisk class 4).</p>

<p  class=anno>After bad experiences with both Class 10 Transcend  and
Lexar,  I've  now settled on a reliable Sandisk class 4  16GB  microsd
flash.  As Sandisk chooses labels according to the minimum write rate,
it  is nearly as fast as the others. One advantage is that I no longer
find the chroot remounted read-only, as this means to shutdown/restart
the chroot and running fsck (no loss of data though). When switching I
had  a  look at the external sdcard's FAT filesystem and  my  titanium
backup files:  Massive  data corruption. Flash problems may well  have  been
worsened  by  whatever timeout changes Google patched  into  the
kernel.</p>



<p>Power  considerations: to save battery,</p>
<ul>
<li>enable automatic battery savings  in Settings.
<li>turn off WLAN and GPS - the location by cell towers is still
pretty exact. 
<li>if necessary, you can also use <i>titanium backup</i> to freeze
some of the more annoying and power hungry apps in your firmware (kies, socialhub).
</ul>

<p>Known pitfalls to avoid:</p>
<ul>
<li><i>adb</i> and using symlinks in Android-side paths - silent failure.
<li>bad flash (in all possible meanings)
<li><i>kies</i> (connectivity suite / flashing software provided by Samsung for Windows)
<li>use of app2sd: do move all apps to the phone (/data) - the core of
    the Android framework has <B>MAJOR PROBLEMS</B> with apps on sdcards,
    upto and including hanging in a boot-loop (recover by full wipe or
    by <i>adb shell</i> from the PC and removing any packages on the sdcards;
    access by ssh with <i>sshdroid</i> is not possible).
</ul>



<br>
<h4>The Whys of Rooting</H4>

<p>Besides  getting faster access to upstream security and bug fixes than
by  waiting for something to trickle down from Google to Hardware Maker
to Provider to OTA distribution, rooting enables more options for</p>

<ul>
<li>backup/restore
<li>battery management
<li>privacy (<i>lbe privacy guard</i>, <i>aspotcat</i>, ...; iptables-based "personal" outbound firewalls)
<li>routing (improved tethering and intelligent "routing" at ip route/iptables level)
<li>security (<i>lookout</i>, <i>avast</i>; the ability to create a real iptables-based inbound packet-filter/firewall)
<li>access to non-Android programs, for the Android shell or for a chroot containing a real Linux install
</ul>

<p>Depending  on  how  you  root the device,  the  flash  counter  may
increase                (though                that                 <a href="http://forum.xda-developers.com/showthread.php?t=1354888">301K
resistor  field  testing jig</a> may help). But in case of mailing  in
the  device  for  service, you need to reflash a  stock  firmware  rom
anyway. Thus for me, the conclusion was: <i>so what</i>.</p>




<br><h4>A Sabbatical for Research</h4>

<p>ROMs  are very device specific, so Android ecosystem and  community
are  <i>extremely fragmented</i>: <b>Good community support and custom
ROMs  are IMHO a pre-requirement when buying Android devices</b>. Some
custom  roms  reuse vendor stock kernels and/or stock roms,  some  use
custom  kernel  builds  (usually  based on  the  Android  Open  Source
Project/AOSP; e.g. cyanogenmod).</p>

<p   class=anno>Bad  makers  or  lack  of  community  lead  to   early
obsolescence  of the device and wasted money (consider the  disastrous
Motorola  Milestone).  Depending on the number of non-standard  chips,
various firmware-blobs might be required to get a fully working kernel
and/or "rom". With some makers not even supporting devices at start of
sale,  the initial release kernel might well be the only Linux  kernel
ever  working  on  a  device that supports  all  hardware  (again  the
Milestone  example:  blobs issue plus a signed bootloader). This  will
also  worsen  community support and shorten availability of  community
firmware  for this maker's devices (as any rom would have to reuse the
old, unmaintained and probably also buggy kernel). <b>Some</b> of this
is  already  visible for the Note as well: the unofficial  CM9  builds
currently still lack blobs for camera and accelerated display.</p>

<ul>
<li><a href="http://forum.xda-developers.com/forumdisplay.php?f=1349">XDA Note forum</a>
<li><a href="http://sammobile.com">Sammobile</a> (aka samfirmware.com aka samsung-firmwares.com; also contains stock images for reflashing)
<li><a href="http://forum.xda-developers.com/showthread.php?t=1424997">XDA: stock ROM list and ROM overview</a>
<li><a href="http://cyanogenmod.com">Cyanogenmod</a> and 
    <a href="http://teamhacksung.org/wiki/index.php/Main_Page">teamhacksung</a>
    (only preliminary unofficial CM7 and CM9 builds for the Note, still lacking some blobs; 
     <a href="http://forum.xda-developers.com/showthread.php?t=1423795&page=52">XDA: cm9</a>)
<li>ROM: <a href="http://forum.xda-developers.com/showthread.php?t=1331784">XDA: Chainfire's CFROOT with CWM (clockworkmod)</a>
<li>ROM: <a href="http://forum.xda-developers.com/showthread.php?t=1352945">Sheeprom</a> by Frank_M aka Riversource
<li>ROM: <a href="http://forum.xda-developers.com/showthread.php?t=1424401">Chris_X ROMs</a> by Chris_X
<li>Other mentions were villain ROM and <a href="http://forum.xda-developers.com/showthread.php?t=1380284">XDA: rocket v13</a>.
</ul>

<p class=anno>(state 201112-201201, Note gingerbread ROMs)</p>



<br><h4>Pre-Flashing Checklist</h4>


<ul>
<li>create and validate a backup suitable to recover ALL of your device from a 
    barebones custom ROM install.
<ul>
   <li>if not yet installed, do install <i>titanium backup</i> from market.
   <li>if still unrooted, and you do need a backup of user apps, consider e.g. <i>mybackup</i>.
   <li>if possible, ensure that you have a copy of the /efs contents somewhere (IMEI!)
   <li>consider backups of your "sdcards": /mnt/sdcard and /mnt/sdcard/external_sd.
   <li>consider a backup of /data, even if only <i>tar cf /sdcard/data0.tar /data</i>
   <li>consider using <i>titanium backup</i> to backup user/system apps and data.
   <li>validate your backup!
   <li>consider using cfroot/cwm to do a backup from the recovery ROM:
       way faster than titanium to recover the previous state, but not
       that useful on restoring user data into a new custom ROM, as it
       is easy to restore "too much".
   <li>consider copying the backup to your PC! If that happens 
       automatically as part of a nightly backup run, do manually check that copy!
</ul>
<li>ensure that USB-debugging is enabled and <i>adb shell</i> still works
<li>check the battery level!
</ul>


<br><h4>The Way of Rooting (Tourist Travel Sketch, with dog-eared threads)</h4>

<p>At the end of the research phase, you should have selected a target
custom  ROM, and maybe one or more intermediate steps if you start out
with  a stock ROM. In my case the sequence led from stock back in time
to  a full install of the older KJ1 with CFROOT/CWM, and then  forward
again  to  Chris_X 4lph4 ROMs offering KL8 using the AbyssNote  2.6.35
kernel.</p>

<p><i>Stock to Chainfire KJ1 including the modified factoryfs</i> (see
<a href="http://forum.xda-developers.com/showthread.php?t=1331784">posting
1+2</a>).  If  your  ROM doesn't offer CFROOT/CWM, you first  need  to
install  a version of <i>odin</i> on Windows that lists the Note as supported
(v3  version 1.83 or 1.85 was the one I found - there doesn't seem  to
be any official home page or author, nor any sane version numbering; a
list        if       provided       e.g.       in       this        <a href="http://droidangel.blogspot.com/2011/05/odin-multi-downloader-flasher-program.html">overview</a>).
For  Linux,  <i>heimdall</i>  might  work (untested). To set  the  Note  into
download  mode,  use lower-vol + home + power and connect to USB.  For
more detail, check the XDA threads for your selected ROM.</p>

<p><i>Chainfire     KJ1     to    Chris_X    4lph4</i>     (see     <a href="http://forum.xda-developers.com/showthread.php?t=1424401">XDA</a>).
As  we  now  have CFROOT/CWM available, this step no  longer  requires
Windows  and Odin. I repeated this step once to go to a newer ROM from
Chris,  currently the v1.0.5 from early January, which is very  stable
(excluding  Google's  carefully  prepared pitfalls  concerning  shared
memory  and  system_server vs app2sd - given that Chris is  using  the
AbyssNote  kernel and source for older AbyssNote kernels can be found,
we may be able to undo some of that damage and recompile the kernel).

<p  class=anno>As of mid February, Chris is at v1.7.</p>

<p  class=anno>I  will  follow  Chris once in a  while  until  ICS  is
available  as a CFROOT/CWM supported ROM. In the long run, I'll expect
to end up on CM9 or newer.</p>

<p>Notes:</p>
<ul>
<li>entering recovery: CWM application or upper vol + home + power
<li>using CWM to delete the contents of the cache partition and dalvik
cache  is  a  good  idea (the last adds about  15min  to  the  initial
boot).
<li>you may need to be selective in restoring titanium backups: browser 
and market may have different versions, so restoring user data may lead to force crashes.
This fragility is why Chris strongly requires full wipes as part of the install. Note
that restoring 300 user apps takes a whee bit of time.
<li>if you made a CWM Backup before flashing, do not use it as-is from CWM
recovery, as you'd restore the previous state and fully or partially undo
a successful flashing. Though it's perfect to undo a bad flashing or to go back
from testing another ROM.
<li>consider turning off OTA updates (Settings -&gt; About Phone -&gt; 
Software updates). While still a pretty rare event, Samsung is one of the select
few Android makers that actually publish ROM updates.
</ul>



<br><h4>Post-Flashing Checklist</H4>

<ul>
<li>check /data/system/uiderrors.txt (chown/chgrp as required as root or try CFROOT's
    fix permissions menu point in the recovery shell; uninstalling all affected apps is another
    option via market or <i>pm uninstall</i> in the shell)
<li>optional: consider doing an immediate fresh-custom-ROM-install backup, maybe 
    as simple as <i>tar cf /sdcard/data1.tar /data</i>, but don't overwrite any of your previous backups.
<li>optional: copy the backups from the PC back to the Note
<li>(selective) restore of applications (and possibly data) using <i>titanium backup</i>.
<li>use <i>zdbox</i> to move any apps on sdcard back to the phone (there are preference
    settings, but some apps always get installed on sdcard)
<li>check /data/system/uiderrors.txt again
<li>skim through the Android's settings menu:
<ul>
<li>fix language settings, reenable keyboards and assistance (if using e.g. <i>clip ninja</i>)
<li>test if application -&gt; USB debugging still enabled
<li>power settings
<li>phone menu: disable OTA software updates (this protects rooting/superuser in case of an 
    improbable OTA update by maker or provider)
<li>...
</ul>
<li>restore your widgets (e.g. <i>quick agenda</i>; <i>floatmemo</i>, <i>coolapps</i> and <i>smart task switcher</i> 
    might also be classified as offering widgets)
<li>check apps that should run on boot / have active schedules (in my case: <i>titanium backup</i>, <i>tasker</i>, 
    <i>lookout</i>, <i>LBE privacy guard</i>, <i>ring guard</i>, <i>smart task switcher</i>)
<li>check <i>terminal ide</i> and root access
<li>from the PC, check the SDK's <i>adb shell</i> access as well as ssh access via <i>sshdroid</i>
<li>check logcat in the shell (is there a need to run insmod /lib/modules/logger.ko or similar?)
<li>rerun sl4a installers (perl apk file is e.g. the installer/uninstaller for perl)
<li>restore your ring and notification tone settings
<li>check apps (e.g. by <i>titanium backup</i> or by ls /system/app) for applications to 
    disable (<i>titanium backup</i>: freeze)
<li>optional: restore your own modifications to the Android shell and to 
    the <i>terminal ide</i> environment (run /s/INSTALL from part two to recover Android shell 
    modifications, scripts, binaries and symlinks; if lost, do recover the contents of /s
    and the root account for <i>terminal ide</i> from backup. In my case /s should be a symlink
    pointing to /data/local/setup, which currently points to /mnt/sdcard/COMPACT/setup).
<li>optional: if already installed: check mc, bash, vi/vim in the shell and in <i>terminal ide</i>
<li>optional: check the availability and functionality of the chroot setup
</ul>

<p>Finally</p>
<ul>
<li>restore /etc/openvpn from the backup (for now, this is intentioanally skipped by INSTALL)
<li>check /data/system/uiderrors.txt again
<li>make  a new backup and copy that to the PC (not  replacing your old one from pre-flash)
</ul>


<br><h4>Software</h4>

<p>1. Nice to have market apps to improve on Android graphical offerings:</p>
<ul>
<li><i>apg</i> (an Android frontend for pgp/gpg encrypted files)
<li><i>aspotcat</i>, <i>lookout</i> or <i>avast</i>, <i>lbe privacy guard</i> (security, permissions, receivers, intents)
<li><i>clipper</i>, <i>clip ninja</i>, <i>floatmemo</i> (without a window system, we need help to transfer data between apps)
<li><i>clocksync</i> (to keep your clock in sync with NTP)
<li><i>coolapps</i> (system load widget and much more)
<li><i>jota</i> (nice text editor)
<li><i>k9</i> (nice mailer)
<li><i>mobile odin</i> (custom ROM flasher, see also the <i>cwm</i> app, which should be part of the custom ROM)
<li><i>printbot</i>, <i>scanthing</i> (printing and scanning, with OCR by uploading to google docs; also consider 
    adding some simple office suite app (most also double as - usually slow - pdf readers)
<li><i>ring guard</i> (the Note's way better than the Milestone in this regard, but I still accidentally 
            manage to change ring tone loudness)
<li><i>smart taskswitcher</i>, <i>task manager</i>
<li><i>tasker</i> (programmable Android event handling, can substitute for cron, can turn on/off WLAN depending on location, etc)
<li><i>terminal emulator</i>
<li><i>zdbox</i> (task killing, moving apps from sdcard to phone)
</ul>

<p  class=anno>(voice recognition and more than word-level handwriting
recognition  aren't quite there yet in gingerbread; evernote  features
the  last  one, but the recognized text is inaccessible and only  used
for indexing/searching)</p>


<p>2. Required market apps for the rest of this article:</p>
<ul>
<li><i>busybox installer</i> (from stericson, use /system/xbin as installation path)
<li><i>connectbot</i> (ssh app to connect to remote systems)
<li><i>file expert</i> or any other filemanager capable of accessing non-sdcard or root directories
<li><i>sshdroid</i> (permit incoming ssh connections, dropbear-based, also including ssh/scp)
<li><i>superuser</i> (usually part of the custom firmware: a fake su coupled 
       with popups to ask the user to accept/deny, and an editor for stored decisions about application root requests)
<li><i>terminal ide</i> (a pretty complete unix user space for the Android shell; works well even without root)
<li><i>titanium backup</i> (backup and restore; also offers dealing with offending firmware apps)
<li><i>xvnc</i> or <i>vnc viewer</i> (we use them in part 4)
<li>mostly optional: <a href="http://code.google.com/p/android-scripting/">sl4a and perl</a> (perl/python/lua wrapper
    examples are available for use in the Android shell; some of my Android shell scripts may require perl)
</ul>

<p  class=anno>(there also are one or two apps that intend to simplify
the  creation  of  the chroot for sections 3 and 4 of this  article  -
search for linux installer on the market; usually either Ubuntu or DEBIAN)</p>


<p>3. PC applications</p>
<ul>
<li><i>adb</i> (in the <a href="http://developer.android.com/sdk">Android SDK</a>, tools directory)
<li>(the initial flashing above required one-time use of <i>odin</i> or <i>heimdall</i>; <i>kies</i> 
    may or may not offer that feature, but according to most threads, <i>kies</i> is 
    one of those four letter words rather than a usable application)
</ul>


<p>The    <a href="02_twlaunch.html">second   article   looks    at
twlauncher</a>  in  more detail and includes some more categories  and
app  suggestions sorted into those categories - if you want to call my
personal app collection by that lofty title.</p>

<br><p><b>Summary:</b>  By now you've a rooted Android device, seen a  few
XDA support threads as well as some checklists for use when reflashing
the ROM.</p>




<!-- ------------------------------------------------------------------------------------- -->
<hr><a href="#toc">(table of contents)</a><hr>
<a name=shell></a>
<H3>Adding Unix Standards to the Android Shell</H3>

<p>Do run and setup each of <i>busybox installer</i>, <i>sshdroid</i>,
<i>terminal ide</i>, <i>titanium backup</i> and <i>superuser</i>. From
now on, I assume that</p>

<ul>
<li>you've a Linux PC available (if you want to look at the automation examples incl. nightly backup and monitoring)
<li>grep, sh, etc is available in /system/xbin (<i>stericson busybox installer</i>)
<li>running <i>su</i>, then <i>id</i> in <i>terminal ide</i> shows either root or the numerical id 0 (otherwise 
    verify <i>superuser</i>; note that the Android shell <i>su</i> is not the normal Linux <i>su</i>)
<li>you can run <i>shh root@&lt;WLAN IP of your device&gt;</i> to start an Android shell using the dropbear daemon (check <i>sshdroid</i>; 
    your public key goes to /data/data/berserker.android.apps.sshdroid/.ssh/authorized_keys)
</ul>

Further assumptions and settings of my setup (please also check in case of errors):
<ul>
<li>my hostname of the Note is note or note.compact: <i>hostname note; echo "127.0.0.1 note.compact note "$(getprop net.hostname)" localhost" >> /etc/hosts</i>
<li>DNS lookup should probably be provider-independent: 
   <i>(echo nameserver 8.8.8.8; echo nameserver 8.8.4.4) > /etc/resolv.conf</i> in case something queries /etc; 
   <i>for i in net.pdp0.dns1 net.eth0.dns1 net.dns1; do setprop $i 8.8.8.8; done</i> for anything using bionic or the
   Android framework.
<li>If you see a hardcoded WLAN IP of 192.168.2.114, please replace it with your own Note's WLAN IP. 
<li>If you see a hardcoded WLAN IP of 192.168.2.6 or the name anuurn: this refers to my Linux Box, please replace it with your IP on the WLAN.
<li>/s is a symlink to /mnt/sdcard/COMPACT/setup. /s/INSTALL is the script responsible
    installing my symlinks and scripts into the Android shell.
<li>system/xbin or just xbin is the directory containing most of my scripts, armel binaries and
    a DNS-resolving copy of <i>busybox</i>.
<li>/x will be the mountpoint of the chroot below. Inside, it is a symlink to the root of the chroot.
    If it is obvious, I shall omit the /x prefix. Thus /root and /home/jakobi with or without 
    leading slash are paths in the chroot. 
<li>/x/abin or just abin is the chroot directory used for chroot-specific glue scripts complementing 
    the scripts in system/xbin, many of which are usable also from within the chroot.
<li>the example home/jakobi/bin/shell/android.func defines some shell aliases to interact with the
    Note from a Linux box: inote, notescp, notessh
<li>of course, all of these paths are also valid inside the host-specific subdirectory in the tarball
</ul>

<hr><center><p  style="background-color:#ffddcc"><i>Please    unpack    a    copy    of    the    <a href="https://github.com/jakobi/script-archive/blob/master/android/android-setup-example-files.tgz?raw=true">example
files</a>  somewhere (though</i> <b>not in / on your Android</b><i>). You
can                   check                   the                   <a href="http://github.com/jakobi/script-archive/tree/master/android">Android
directory</a>  for updated versions, as I will only very  infrequently
update  the  tarball. ./host.note is an extract of the  Note's  files,
while    ./host.anuurn   contains   some   files   from   the    Linux
PC.</i></p></center><hr>

<p>If you intend to use my INSTALL script to modify your Android shell
setup,  only  files  below /s (or /mnt/sdcard/COMPACT/setup)  will  be
considered  by INSTALL, so please start with empty /s/data, /s/system,
and  /s/root-tarballs  directories and simply modify and add  scripts,
tarballs  and  configuration, as you proceed through the  article  and
find interesting tidbits. In the example files, the location is
host.note/mnt/sdcard/COMPACT/setup/INSTALL.</p>




<p>Now that we've taken care of the basics and have access to a rooted
Note,  let's get to the more interesting parts of this article.</p>



<br><h4>Differences  from  a real Linux system</h4>

<p>libc  and  the most visible problem: Google reinvented an  embedded
small  libc  clone  by  the name of bionic, which  together  with  the
Android  framework  implements DNS access in a non-standard way.  This
leads to some confusion in porting as whether to look at the output of
setprop  and  make quite a few code modifications or just look at  the
files in /etc and hope that something (the user...) keeps them in sync
with  the framework's properties (setprop/getprop shell command).  For
<i>busybox</i>,  the stericson version you installed into /system/xbin
can  access DNS properly, while the versions from <i>sshdroid</i>  and
<i>terminal ide</i> currently do not and only permit raw IP addresses.
In  my  setup,  I have defined an alias iresolver to reorder  PATH  to
enable DNS-related shell commands.</p>

<p>Google   also   reinvented  the  wheel  with  logcat.  Again   with
interesting  effects:  they didn't mangle all parts of the kernel,  so
many  kernel messages never make it to logcat at all. Worse, there  is
no  syslog/klog,  and  messages at best can be seen for a  very  short
period  in a much too noisy <i>dmesg</i> output. The lost messages include
uninteresting topics such as logged packets from user-created iptables
rules.   However,  messages  about  filesystem  data  corruption   are
similarly mistreated. Which just happens to be a <b>severe reliability
issue</b>.  Note that there's nothing in a chroot that can work around
this problem.</p>

<p class=anno>(logcat use may require insmod /lib/modules/logger.ko)</p>

<p>Other things that are not available on my Note (might be fixable by
a kernel arm-toolchain rebuild if we get the current Source and config
for the AbyssNote kernel, hoping that they're merely (badly) unconfigured 
rather than broken by bad patches):</p> 
<ul>
<li>shared  memory.  Again improperly  removed/unconfigured,  leading to crashes and  the  shared
memory  workaround  reported later on, when we deal with X11 apps,  as
these  are most likely to take advantage of shared memory. 
<li>NFS  client and server support
<li>swap space and swap to file
</ul>


<p>The  low-power portions of the Google patches neglect to  properly
fix   sleep.   So   without   active  wake_locks   to   avoid   system
suspend-to-ram,  even a one second sleep is completely unreliable  and
may  have  a duration of a few minutes. Large sleeps are affected  way
worse:  Sleeps  aren't ended when the system activates again  and  the
real  time  advanced beyond the intended end of sleep. Thus  a  chroot
cron  becomes  pretty  much unusable  without  constantly  maintaining
active  wakelocks.  See  the  example  <i>system/xbin/WAKELOCK</i>  to
set/clear/list wake locks.</p>

<p  class=anno>(see also <a href="http://lwn.net/Articles/318611/">LWN:
Wakelocks and the embedded problem</a> - inconsiderate patches such as
these  with  heavy collateral damage do have a hard time to  make  it
upstream into the Linux kernel sources)</p>



<br><h4>Notes on Functionality and Commands</h4>

<p>Editing  text:  a  simple vi clone is part of busybox, and  can  be
found  in /system/xbin, and as part of <i>sshdroid</i> and <i>terminal
ide</i>  copies  of  busybox.  A real port of <i>vim</i>  is  available  with
<i>terminal   ide</i>.   On   the  graphical   side,   consider   e.g.
<i>jota</i>.</p>

<p>I  found  a few working static armel binaries for <i>bash, mc,  rsync,
strace,  tcpdump,</i> and <i>wget</i>. They are included in the example files  in
system/xbin.  Bash and mc are also included with <i>terminal  ide</i>,
but  the mc version lacks sub-shell support. A simplified
wget is also part of busybox.</p>

<p>The shell: <i>sh</i> is part of both busybox and toolbox. As I've run into
a  slew of toolbox bugs, I'd suggest to use /system/xbin/sh. Or  <i>bash</i>,
as mentioned in the previous paragraph. (consider a symlink /bin/bash,
but it's probably better to avoid /bin/sh). Don't mix GNU programs and
busybox  programs within a single pipe hosted by busybox sh  (spurious
output write errors between pipe stages).</p>

<p>To  use  <i>perl</i>  in the shell, see the system/xbin/perl  example  and
install      <i>sl4a</i>      and      the     perl     apk      from      <a href="http://code.google.com/p/android-scripting/">Scripting Languages
for  Android</a>.  Python  and lua wrappers are also included,  but  I
don't  really use them. In case of <i>sl4a</i> crashes, uninstall  and
reinstall  the  crashing  language.  Consider  creating  the   symlink
/usr/bin/perl  and  adding  /usr/bin  to the  PATH  to  permit  normal
invocation.</p>

<p  class=anno>To use the Android GUI in say ssh scripts, you need the
access  data  from a running "host environment" like <i>sl4a</i>:  run
the  shell  in <i>sl4a</i> and redirect the output of set to  a  file.
Keep open <i>sl4a</i> and set suitable environment variables according
to  the captured output. Maybe also of interest/possibly working as  a
"host":  <i>tasker</i>  and  <i>taskbomb</i> with its  script  support
(all 3 available on market).</p>

<p class=anno>(in case you do not want <i>sl4a</i>: at the end of part 3, you
will  also  be able to alias <i>perl</i> to <i>x perl</i> and use  the
chroot's perl installation)</p>

<p>Script examples:</p>
<ul>
<li><i>CHROOT.run</i> (aliased to x); starts a shell in the chroot or
    run chroot commands as part of a pipe. But more on this will
    have to wait until part 3.
<li><i>/s/INSTALL</i> (Android shell customization script: install and update 
    apps in /system/xbin, create links like /i and /e for the scards,
    /s, /t, ..., 
    add scripts to the Android boot process. The master copy of
    tarballs and scripts/configuration is also contained in the
    subdirectories of /s)
<li><i>psg</i> is a <i>ps -ef|grep</i> style script. It also offers to list
    non-standard jobs of interest, or to classify processes as kernel / Android 
    framework+Java / shell or chroot. As busybox doesn't implement <i>ps -ef</i>,
    the script uses busybox top as base.
<li><i>TOP</i> augments to output of <i>busybox top</i> with various Android specific information
    from watching df, checking that interesting filesystems are still read-write,
    to battery status and cpu frequencies. No interactive top command keys.
<li><i>VPN*</i> are the openvpn setup scripts, see the section on networking below.
<li><i>WAKELOCK</i> is a convenient wrapper used to setup/discard and list wake locks, 
    and used in many of the other scripts or remote cronjobs.
</ul>



<pre>
# 1. output from TOP; the FLAGS are be M  (mail), FS! (fs remounted-ro), and
#                                      U! (errors in /data/system/uiderrors.txt)

BAT: 90(disc)  CPU: 0(0.1)                &lt;FLAGS&gt;  192.168.2.114 20120219-16:30:27
Mem: 762928K used, 48176K free, 0K shrd, 40272K buff, 165484K cached
CPU:  0.0% usr 10.0% sys  0.0% nic 90.0% idle  0.0% io  0.0% irq  0.0% sirq
Load average: 1.80 1.31 1.26 2/732 5270

  PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND
 3459  2590 1000     S     407m 51.2   0  0.0 system_server
 8207  2590 10072    S     270m 34.0   1  0.0 {d.process.media} android.process.
27066  2590 10015    S     254m 32.0   0  0.0 {.app.twlauncher} com.sec.android.
16765  2590 10092    S     251m 31.6   0  0.0 {app.emailwidget} com.sec.android.


/dev/block/mmcblk0p9    858752    802860     55892  93% /system
                       2064208   1408044    656164  68% /data
                      11613376   2002848   9610528  17% /mnt/sdcard
                       4427304    576092   3851212  13% /mnt/sdcard/external_sd
/dev/block/mmcblk1p2   9289080   3410268   5690072  37% /


# 2. output from psg 2&gt;&amp;1 | cut -b-120
# the first block lists open shells on STDERR, the second programs of interest
# : is a normal shell command, R is running in the chroot, 
# A is Android/Java,           K is kernel
: pts/2     6641  6636 root     S      800  0.1   0  0.0 -sh
: pts/2     6715  6712 root     S     1800  0.2   0  0.0 /data/data/com.spartacusrex.spartacuside/files/system/bin/bash
: pts/0    16898 16889 root     S      800  0.1   0  0.0 -sh
R pts/0    16914 16898 root     S     4880  0.6   0  0.0 /bin/bash
R pts/2    24103  6715 root     S     4940  0.6   0  0.0 /bin/bash
R -        26190 26162 root     S     4864  0.6   0  0.0 bash

: pts/2     6712  6641 root     S      800  0.1   0  0.0 {t} /system/bin/sh /data/data/berserker.android.apps.sshdroid/d
: -        23920     1 10122    S    15772  1.9   0  0.0 /data/data/com.theqvd.android.x/usr/X11R6/bin/Xvnc :0 -br -loca
R -        26143     1 root     S    15388  1.8   0  0.0 icewm
R -        26162     1 root     S     9356  1.1   0  0.0 xterm
R -        26202     1 root     S     3528  0.4   0  0.0 /usr/bin/dbus-launch --exit-with-session x-session-manager
R -        26203     1 root     S     2892  0.3   0  0.0 /usr/bin/dbus-daemon --fork --print-pid 5 --print-address 7 --s

# 3. short output of psg -m dropbear | grep 6636 | cut -b-120
: -         6636 root       0:01 /data/data/berserker.android.apps.sshdroid/dropbear/dropbear -H /data/data/berserker.an

# 4. long output of psg -l -m dropbear | grep 6636 | cut -b-120
: -         6636 11159 root     S     1084  0.1   0  0.0 /data/data/berserker.android.apps.sshdroid/dropbear/dropbear -H
</pre>



<br><h4>Treasure Trove Terminal IDE</h4>

<p>(there's no need to use java and the ide to really profit from installing and using <i>terminal ide</i>)</p>

<p><i>terminal  ide</i>  aims to make standard  Unix commands
available  to permit working with vim and java, thus the <i>IDE in the
terminal</i>  name. This provides the best working environment for the
Android shell outside of a chroot, and it doesn't even require root. It offers e.g.</p>

<ul>
<li>use of 4 terminal sessions when used as a graphical frontend
<li><i>bash</i> (this lacks subshell/jobs support)
<li><i>busybox</i> (though lacking DNS-resolving; see the iresolver function or
    temporarily prepend /system/xbin to the $PATH)
<li><i>mc</i>   (this lacks subshell support, consider running the 
   system/xbin/mc binary from the example files or the chroot's <i>x mc -a</i>.
<li><i>tmux</i> (screen-style terminal multiplexer, configured to use CTRL-a as command key)
<li><i>vim</i> (_the_ editor; way better than vi, and much better than the busybox vi subset)
<li>...
</ul>

<p>With  some  coaxing in the form of custom profiles and  the  script
system/xbin/TERMIDE  (aliased  to t), the environment is also usable  outside  of the
app,     e.g.     from     ssh    or    for     root.     See     both of
data/data/com.spartacusrex.spartacuside/files/{root/,}.
The  example  profiles
will  also  clone two bash files from the chroot's root  account  into
data/data/com.spartacusrex.spartacuside/files/root   to   maintain   a
single  environment  inside  and  outside of the  chroot,  inside  the
<i>terminal  ide</i> app and outside, for both the <i>terminal ide</i>
user account or for root. Running the app is not required for this.</p>

<p>Notes</p>
<ul>
<li>a <i>terminal ide</i> bash may block attempts  to  run
    <i>mount  -oro,remount /system</i>. <i>/s/INSTALL</i> reliably triggers  that issue.
<li>injecting root profiles into files of another Android app in /data/data
    isn't the sanest thing to do. But it works, and the 
    normal <i>terminal ide</i> user account needs similar settings anyway. Take
    a look in case of restoring with titanium backup, but other than mc 
    creating a new profile, nothing should happen. Wrt. security, the Android
    setup is single-user in the first place, abusing IDs for the purpose
    of isolating apps against each other. Given that we need to
    run <i>terminal ide</i> binaries as root anyway, there's no additional risk to consider.
<li>a fully configured <i>vim</i> with syntax highlighting might hang for when
    the sdcard is busy with heavy writing. For tiny edits,
    just ssh on the machine and use the busybox version.
<li>the app also offeres two <i>full keyboard layouts</i>. However 
    e.g. CTRL isn't accepted by other apps, including all vnc apps!
    There is also a bug that affects the <i>Google search widget</i>, forms in the
    <i>default Android browser</i> and <i>mobile firefox</i>, which don't 
    accept the return key as 'Go' - sometimes without offering an alternative
    'go' button above the keyboard. 
    Work-around: temporarily switch back to the Samsung keyboard.
</ul>



<p><b>Errata: Terminal IDE screenshot?</b></p>

<br>
<h4>Interacting with the Android Framework and the Android GUI</h4>

<p>We  can use the <i>am</i> shell command to invoke java entry  point
classes  and send intents to the framework-side. As am invocations can
be  lengthy,  a  small wrapper for use in chroot or android  shell  is
helpful:                                                            <a href="https://github.com/jakobi/script-archive/blob/master/android/dir.android-unix-userspace/VIEW">VIEW</a>.
See  the script itself for more details. To get supported entry points
and  mime-types,  check the manifest file included in the  application
apk.  Note  that most intents are intended only for app-internal  use;
furthermore,  the  am command is a debugging tool and  doesn't  return
proper  result values. Note also that intents from <i>am start</i> for
already  running  apps/intents  will fail and instead bring the running
app/intent to  front.</p>

<pre>
# wrapper invocation and corresponding am intent invocation
VIEW CALL tel:3311                    # am start -a android.intent.action.CALL tel:3311 # actually do the call
VIEW      tel:3311                    # am start -a android.intent.action.VIEW tel:3311 # view entry (same as DIAL)
VIEW /long/path/file.mkv              # am start -a android.intent.action.VIEW -d file:///long/path/file.mkv \
                                      # -n com.clov4r.android.nil/com.clov4r.android.nil.MainActivity
VIEW 'geo:NewYork,USA'                # am start geo:NewYork,USA / am start 'geo:0,0?q=NewYork,USA'
VIEW http://leo.org                   # am start http://leo.org / am start -a android.intent.action.VIEW \
                                      # -n com.android.browser/.BrowserActivity -d http://leo.org
# display home screen                 # am start -a android.intent.action.MAIN -c android.intent.category.HOME 
# view contact entry # 815            # am start -a android.intent.action.VIEW  -d content://contacts/people/815 \
                                      # -t vnd.android.cursor.item/person # required to resolve to contacts app (!?)
</pre>


<p class=anno>Further reading: 
<a href="http://developer.android.com/guide/appendix/g-app-intents.html">Intents List: Invoking Google Applications</a>,
<a href="http://developer.android.com/reference/android/content/Intent.html">Intents, (Broadcast-)Receivers, Background Services</a>, 
<a href="http://www.kandroid.org/online-pdk/guide/instrumentation_testing.html">Instrumentation Testing with AM</a>, 
<a href="http://developer.android.com/reference/android/app/ActivityManager.html">ActivityManager.html</a>, 
Helpful apps include <i>Android Intent Playground</i>, <i>ManifestViewer</i>, and <i>Intent Intercept</i>.
</p>

<p  class=anno>(I cannot find any content://com.android.contacts/  URI
examples  for contact search by name and display of result list in the
contacts          app          (excluding          maybe          just
content://com.android.contacts/phone_lookup/&lt;NUMBER&gt;)   -  every
example encodes the query, possibly including some pseudo-SQL and then
iterates  using a database cursor, and at most only then triggering  a
display  intent  of an individual numeric contact &lt;ID&gt;. So  this
seems  to  require  more  than a simple am intent command:  a  bit  of
programming  in Java or SL4A or just fully bypassing the framework and
parsing  the  raw contacts database, similar to what I'll show in  the
second  article for twlauncher. It's however quite annoying that  some
schemes  like  geo:  URIs are expressive enough to  include  arbitrary
queries,  while on the other hand the contacts provider requires extra
effort  -  besides  crashing on most URIs. Search  intents  using  the
quicksearchbox  also fail, as I don't seem to be able to  successfully
provide  a  query string. Intents do expose some internals for  reuse,
but  Google's  design  is fragile and  lacks  standardization,  making
intents   for  ipc  and  application  reuse  needlessly  difficult  to
unusable)</p>


<br>

<p>For the opposite direction, we need to start Unix commands from the
framework.  This  can  be as simple as Java  invoking  system()  (e.g.
<i>tasker</i>  invoking  shell  scripts  depending  on  location,   or
regularly  running  the  "fake" cron  <i>abin/CRON.15min</i>  as  used
below).  Or as indirect as using intents. Both apps and intents can be
placed  as icons on the home screen to trigger the action (in case  of
intents consider apps like <i>xShortcut</i> or <i>Any Cut</i>).</p>

<p>Intent example: Install <i>Scripting Languages for Android/SL4A</i>
and  SL4A Perl (if you see force-close, uninstall and reinstall  using
the  SL4A  Perl  installer). We want to invoke a shell  command  using
intents,   more   specifically   a   Perl  script.   We   use   SL4A's
LAUNCH_BACKGROUND_SCRIPT intent with the ScriptingLayerServiceLauncher
entry  point  to invoke the script. On the shell, you can  create  and
invoke this intent as follows:</p>

<pre>
am start -a com.googlecode.android_scripting.action.LAUNCH_BACKGROUND_SCRIPT \
   -n com.googlecode.android_scripting/.activity.ScriptingLayerServiceLauncher \
   -e com.googlecode.android_scripting.extra.SCRIPT_PATH \
   /x/tmp/test.pl
</pre>
<br>

<p>As  we use SL4A already for the intent example, let's do  something
more interesting: add three lines to display a small framework widget.
As a small lookahead to the chroot setup later on, add another line to
have SL4A Perl invoke the chroot's Perl with a second script, which in
turn   does   the  same  from  inside  the  chroot.  This  works,   as
su/CHROOT.run  retains  the AP_HOST/AP_PORT environment variables  and
permit  use  of SL4A acting as the "framework-side graphical  server".
Here are the scripts used for this example:</p>

<pre>
# /x/tmp/test.pl - the first script as run from android shell or chroot via intent

# su is required for chroot to work 
# (possibly due to SL4A id (e.g. app_247) being undefined inside the chroot?)
use Android;
my  $droid   = Android->new();
$droid->makeToast('Hello, Perl!');
system("su -c '/system/xbin/CHROOT.run perl /x/tmp/test2.pl' > /x/tmp/test2.out 2>&1");
my $rc=$?>>8;
$droid->makeToast("returns $rc");
</pre>
<br>
<pre>
# /x/tmp/test2.pl - interacting with android from within the chroot

BEGIN{push @INC, "/mnt/sdcard/com.googlecode.perlforandroid/extras/perl/site_perl"};
use Android;
my  $droid   = Android->new();
$droid->makeToast('Hello from the Chroot, Perl!');
</pre>

<p              class=anno>Further             reading:             <a href="http://code.google.com/p/android-scripting/">SL4A</a>   and   <a href="http://code.google.com/p/android-scripting/wiki/RemoteControl">remote
control</a>.</p>



<br><h4>Networking</h4>

<p>Browsing:  some  providers  like to mangle HTML pages  and  provide
different  resolution images or even embed extra javascript in  pages.
In  case of the German Telekom, most of this nonsense can be  disabled
by                                                                  <a href="http://speed.telekom.de/laptop_confirmation.php?u=">speed.telekom.de/laptop_confirmation.php?u=</a>.
This  behaviour  was questionable when it started and with  increasing
network  speed  and display sizes, it doesn't get more  reasonable or acceptable.</p>

<p>Using   ssh: An ssh-client can  be  found  as   part   of
<i>sshdroid</i> including sftp server and scp. Another copy is offered
by   <i>terminal   ide</i>.   A  real  openssh  build   is   part   of
<i>sshtunnel</i>, also called the same name. For a graphical client,  consider
<i>connectbot</i>.

<p  class=anno>(note  that  I  was  unable to  trivially  port  an  old
ssh-based  tunnel trick of mine, as some ssh options are not supported
by  any  of these. Work-around: use the <i>openvpn  installer</i>  and
then run <i>openvpn</i> in the Android shell. See system/xbin/VPN*)
</p>

<p>Using   sshd:  As  ssh-server  I  use  <i>dropbear</i>  as   provided   by
<i>sshdroid</i> (<i>terminal ide</i> again provides a second copy) and
only  rarely run a second <i>sshd -p &lt;PORT&gt;</i> on an alternate port in
the         chroot.         See         the         profile         in
data/data/berserker.android.apps.sshdroid.  Adding  keys with the  GUI
didn't  always  work,  so I just copied them into home/.ssh/authorized_keys  in the
above directory.</p>

<p>Using  socks:  <i>proxydroid</i>,  <i>sshtunnel</i>  and   <i>orbot
(TOR)</i>  use  iptables-based forwarding of http/https requests to  a
server-based  based socks daemon. If you want to setup your own  socks
daemon,  take  a look at the hpsockd.conf in the examples  (as  tested
once  on  Ubuntu  10.4; do not use the default port of 1080,  as  some
broken  botnet  seems  to  love attempting email  submission  on  that
port).</p>


<p>the  <i>iptables</i> command is hopefully part of your custom  ROM.
It  is  also available as part of <i>proxydroid</i>,  <i>sshtunnel</i>
and  <i>orbot</i>.  <i>lbe  privacy guard</i> or any of  the  personal
firewall  tools  should  also  contain  or offer  to  install  a  copy.</p>

<p><i>rsync</i>:  I  stumbled upon a static compile (included  in  the
examples)   which  is  as  simple  to  use  as  <i>rsync  -a  --delete
root@note:/DIR  /HOSTDIR</i>.  For  a  backup  solution,  check   e.g.
rsync-backup.  Some  of  the  rsync-related market  apps  should  also
provide suitable rsync binaries.</p>

<p  class=anno>I  think  that  for now I will want to  fall  short  of
providing  the  promised  automated nightly backup  solution  (if  you
silently  add  a  'simple'  in there). In the meantime,  the  files  I
actually  use  in my backup are part of the example files.  My  backup
setup  is  bit  older  than  rsync-backup  and  centers  on  filtering
filelists.  As  invoked for the Note, it also uses rsync for copy  and
cleanup  of removed files, and it also keeps numbered daily/weekly/...
snapshots.              Execution             starts              with
home/jakobi/bin/xfer_backup.wrapper.anuurn.local,  which is invoked by
a  nightly  root cron job (ensure that <i>titanium backup</i>  on  the
Note  is finished first). Furthermore check the copied titanium backup
location  on  the backup target  after  the  first  run  -  I  initially  used
/mnt/sdcard/external_sd/BAK,   however /BAK$   is
automatically excluded in my setup...</p>

<p>Using  a  VPN: OpenVPN and tun.ko is hopefully already part of  the
custom  ROM (or in case of tun.ko optionally also a part of the kernel
-  otherwise run <i>insmod /lib/modules/tun.ko</i> or similar; there also is a <i>tun.ko
installer</i>  on the market as well as an <i>openvpn  installer</i>).
The example files contain a shared-secret openvpn-pair example sans the secret:

<ul>
<li><i>system/xbin/VPN*</i> (with <i>VPN</i> to start the VPN, <i>VPN-ALL</i> to tunnel all
    traffic over the VPN including internet traffic and <i>VPN-NONE</i> for the
    opposite. To end the session, run <i>VPN-NONE</i> and maybe <i>pkill openvpn</i>).
<li>the etc/openvpn files for both the Linux box and the Note (/etc/vpn is NOT handled by INSTALL)
<li>see also the settings menu, which offers additional VPN options.
</ul>


<p>Graphical apps using VNC (or RDP) to view remote computers:  there
are  various  VNC viewing apps available, including  <i>vncviewer</i>,  and
<i>pocketcloud</i>.  For  the  opposite direction, to  view  the  Note's
display   using   VNC and to remote control Android,   consider  <i>androidVNC</i>.</p>

<p  class=anno>(the Note's resolution is great, but my eye isn't  upto
to  the  Note's  300dpi,  so VNC use requires  zooming.  There's  also
a multi-head  issue: no vnc app was up to deal with a multi-head  display
of  two different sized monitors -&gt; run a (smaller) vncserver  on
the remote host)</p>

<p>There is also <i>Xvnc</i>, which combines a VNC viewer hardwired to
connect  to  a locally running VNC server, which in turn acts  as  X11
server (armel binaries included with Xvnc). If you have space issues when creating
the  chroot in part 4, Xvnc is very convenient to skip installing most
of  X11  inside  the  chroot - merely run  <i>aptitude  install  xterm
icewm</i> to install the client-side minimum of X11.</p>

<p>As we install a chroot in the next part, I'm not covering graphical
apps  that access remote files or offer access to remote files.</p>

<p>As  for NFS, without kernel support, you cannot neither access  NFS
files nor offer them.</p>

<p  class=anno>(unless you have access to a Linux box elsewhere and run
fuse sshfs in the direction you want to: The Linux box can then either
offer  the  Note's files per NFS or forward contents of NFS mounts  to
the  Note. Chroot is required  for  this  direction;  see  the  example
abin/SSHFS script later on)</p>

<p>To  connect  to  a  WLAN  and or use the  Note  in  AP  mode  (WLAN
<b>tethering</b>),  just use the settings menu on the Note. To connect
to  the  Note  in AP mode, use e.g. the Gnome network manager  on  the
Linux  box.  For  tethering via USB, connect the Note and  select  USB
tethering.  On  the Linux box run <i>modprobe usbnet</i>,  maybe  also
<i>dhclient</i>  and  have  a  look at usb0.  I  didn't  test  inverse
tethering  (making  the  Note use the Linux Box's  connection  to  the
internet), but on a short search I found 11 pretty dissimilar sketches
from using ppp or ssh or adb with portforwarding to bridging.</p>

<p>Network security</p>
<ul>
<li>Antivirus  is a prime requirement. <i>avast</i> and  <i>lookout</i> on
the graphical app side sound sane and add some device-location and anti-theft features.
<li><i>Personal  firewalls</i> or rather <i>iptables-based outbound packet filters</i>
control outbound packages and are used to augment (<i>LBE  privacy  guard</i>)  or 
substitute  for  actual application  permission management.  Some  antivirus  apps
include  this  feature  when running on a rooted Note (<i>avast</i>). Note
that the  "Android personal firewall" is only slightly more capable than your ordinary "Windows personal firewall" - 
even something as basic as a mere DNS name lookup can leak arbitrary information to a
pre-selected target host. In the Android case, "personal firewalls" are also not
quite the correct place to block apps for ideas such as saving battery.
<li><i>system/xbin/FW</i>: I didn't find any <b>real firewall</b> that deals with inbound packages.
There are some inbound call and sms blockers, but one of the real basics of
network security just doesn't seem to exist for Google and any Android developper on the market.<br>
Work-around: See <i>system/xbin/FW</i> for a script to create and destroy a firewall. It is loosely
based on the rules used by ufw on Ubuntu. Note that we cannot use syslog for logging,
so for rule testing, you need to run <i>dmesg|grep ...</i>
to see output for logged packets.
</ul>



<br><p><b>Summary:</b>  By  now we have a somewhat usable  and  moderately
comfortable  Android  shell.  We  have basic  networking  commands  to
connect  remote  servers and we we can run perl scripts.  An  external
host  can  be used to run shell commands on the Note or run  rsync  to
create  a  file  backup of the Note. We also have seen  an  automation
example  consisting of a remote triggered backup, and we implemented a
real inbound firewall (<i>system/xbin/FW</i>).</p>




<!-- ------------------------------------------------------------------------------------- -->
<hr><a href="#toc">(table of contents)</a><hr>
<a name=chroot></a>
<H3>CHROOT and Turning the Android into a First Class LAN Citizen</H3>


<p>Let me start by pointing back to the warning against bad flash!</p>



<br><h4>Setting up the filesystems</h4>

<p>Let  us  create  an SSD-style 4MB-aligned  partitioning  scheme  by
starting  the first partition at 8192 and have all partitions start at
sector   numbers  divisible  by  8192  (this  might  offer  a   slight
improvement  also  for  sdcard flash(?); if you want to  simplify  the
setup   further,   just   create  a  two   partition   setup   without
alignment).</p>

<p>Sizing:  For a basic desktop tasksel install plus  build-essentials
and some file serving, you need about 3.5GB plus maybe 2GB extra space
during  installation.  A  rule of thumb for a better guess may  be  to
clean  /var, /tmp and run aptitude clean, and double that size to  add
some reserve to permit upgrades. For me that results in using at least
7GB.  Without any desktop task, you should still comfortably fit in  a
4GB  partition  or  in  a  maximum-size  slightly-less-than-4GB   file
container  on  either  the internal or external  sdcard.  However  the
container  file setup requires a loop mount with some overhead, and  I
already  had some data loss on the old external sdcards, so I strongly
suggest to use a separate partition with ext4 for the chroot.</p>

<p>Put the sdcard to use in a card reader on your Linux box and umount
any  automatically  mounted  sdcard filesystems. Then  run  fdisk  and
create the filesystems.</p>

<p class=anno>(the commands are pasted from my notes; I shouldn't have
changed  much  afterwards. Any interesting changes should  be  already
reflected in the CHROOT.mount script)</p>

<pre>
# avoid problems on Ubuntu 10.4 with recent kernels
echo 0    &gt; /sys/block/sdd/queue/rotational
echo noop &gt; /sys/block/sdd/queue/scheduler

fdisk DEVICE                                                      # /dev/sdd for me
# press c and u, and define partitions that look like these

#...
#Units = sectors of 1 * 512 = 512 bytes
#...
#  Device Boot      Start         End      Blocks   Id  System
#/dev/sdd1            8192     8880127     4435968   83  Linux       # type c aka fat32
#Partition 1 does not end on cylinder boundary.                      # &lt;--- ignore this
#/dev/sdd2         8880128    27754495     9437184   83  Linux       # chroot partition
#/dev/sdd3        27754496    29433855      839680   83  Linux       # reserved home/var
#/dev/sdd4        29433856    31116287      841216   83  Linux       # reserved, maybe also swap

# type p to print and check; type w if everything is ok to write/quit fdisk.

mkfs.vfat -n note2 /dev/sdd1 
mke2fs -t ext4 -O extents -F -j -i 16384 -L ARMDEBCHROOT    -m 2 /dev/sdd2 # 600K inodes, 2% root reserve
mke2fs -t ext4 -O extents -F -j -i 8192  -L ARMDEBCHROOT_R1 -m 5 /dev/sdd3 # reserved for /var and/or /home
mke2fs -t ext4 -O extents -F -j -i 8192  -L ARMDEBCHROOT_R2 -m 5 /dev/sdd4 # reserved for swap
tune2fs -c 20 -i 2m -e remount-ro /dev/sdd2 # set fsck requirements nobody will honor
tune2fs -c 20 -i 2m -e remount-ro /dev/sdd3 # and set the behaviour on errors
tune2fs -c 20 -i 2m -e remount-ro /dev/sdd4

mkdir /mnt1; mount /dev/sdd2 /mnt1
</pre>

<p  class=anno>(maybe consider to increase the journal size to  better
spread  writes; this works in case the journal is rolling and doesn't reset
to a fixed start of journal; not checked)</p>



<br><h4>Debootstrap</h4>

<p>Run  stage  1  on the Linux Box and copy the results  to  the
chroot  filesystem.  Both  stable (squeeze) and testing  (wheezy)  are
suitable for use as chroot.</p>

<pre>
debootstrap --arch armel --foreign testing /chroots/sid-armel http://ftp.us.debian.org/debian
(cd /chroots/sid-armel &amp;&amp; cpio -pmdu /mnt1)
sync; sleep 2; umount /mnt1
mount | grep ...
</pre>

<p>Umount  and remove the sdcard from the card reader and reinsert  it
in the Note. Boot the Note. And further prepare the chroot, which will
be mounted at /x.</p>

<pre>
umask 022 # (I had an umask of 011 from dropbear!?)
cd /
mkdir /x
mount /dev/block/mmcblk1p2 /x
mkdir /x/a
cd /x/a
ln -s mnt/sdcard i
ln -s mnt/sdcard sdcard
ln -s mnt/sdcard/external_sd e
ln -s data/local/tmp t
ln -s data/local/setup s
ln -s system/etc .
ln -s sys/kernel/debug d
ln -s data/local/root .
mkdir ./-p ../-p
chmod 444 ./-p ../-p

# mirror the outside files required to run commands (sys, dev, ...)
# as well as make sdcards, system and data accessible from within the chroot
#
# (these commands are also the key part of system/xbin/CHROOT.mount and 
#  required after each reboot of the Note to prepare the chroot for use)
#
mkdir -p proc sys acct system data dev efs cache mnt 
mkdir -p mnt/.lfs mnt/sdcard mnt/usb mnt/obb mnt/asec mnt/app-cache
mkdir -p mnt/secure/asec
#
# I will skip some of the mounts like asec and lfs for now
#
# (it might be interesting to try to run app_launcher also within the 
#  chroot to more directly interact with the Android framework. However 
#  the chroot can also just run ssh localhost to reach the Android shell via sshdroid)
#
mount -orbind /sys sys
mount -obind /acct acct
mount -obind /data data
mount -obind /system system
mount -obind /cache cache
mount -orbind /mnt/sdcard mnt/sdcard
mount -orbind /dev dev
mount -orbind /app-cache app-cache
# we cannot bind anything from rootfs
mkdir COPIED
( cd /; find bin config customkernel dbdata default.prop lib res sbin usr vendor | cpio -pmdu /x/a/COPIED )
ln -s COPIED/* .
#
cd /x
mv dev dev.old
ln -s a/* . 2&gt;/dev/null
# proc must be real and not a symlink
mkdir proc
mount -t proc proc proc  
</pre>

<p>With  the mounts and directories in place, enter the chroot for the
first time, run the second stage of debootstrap to install the initial
system,   and  update  the  system  to  the  current package versions  in  the
repositories.</p>

<pre>
cd /x 
chroot /x

export PATH=/usr/bin:/usr/sbin:/bin:$PATH
export TERM=linux
export HOME=/root
export USER=root

# this requires a few minutes
/debootstrap/debootstrap --second-stage 

# undo the damage done by debootstrap, and restore some of the symlinks
cd /
rmdir sys 
rm -r dev.old; mv dev dev.old
ln -s a/* .
cd /etc
rm mtab;  ln -s /proc/mounts mtab
# android has no sane fstab, just vold.fstab
# shall we combine resolv.conf?
rm resolv.conf; ln -s /a/etc/resolv.conf .
rm hosts; ln -s /a/etc/hosts .
# shall we also use the android side passwd and groups? Not for now.

cd /
# permit using the /x prefix also within the chroot
ln -s / x
# some apps may honor this and do not startup during installation
mv /x/usr/sbin/policy-rc.d /x/usr/sbin/policy-rc.d.ORIG # does not exist
# policy taken from http://wiki.debian.org/ArmHardFloatChroot
echo "echo 'All rc.d operations denied by policy' >&amp;2; exit 101" &gt; /x/usr/sbin/policy-rc.d
mv /x/etc/apt/sources.list /x/etc/apt/sources.list.ORIG # debootstrap version is invalid
echo "deb     http://ftp.de.debian.org/debian testing main contrib non-free" &gt;&gt; /x/etc/apt/sources.list
echo "deb-src http://ftp.de.debian.org/debian testing main contrib non-free" &gt;&gt; /x/etc/apt/sources.list
# change the hostname away from name of the Linux box
echo note &gt; /etc/hostname

# another few minues
apt-get update
apt-get install debian-ports-archive-keyring
apt-get update
apt-get install build-essential

# a first backup of the initial chroot
cd /
find . -xdev | sort &gt; FIND.chroot
cat FIND.chroot | cpio -o -H crc &gt; /i/chroot-initial-debootstrap.cpio
</pre>



<br><H4>Post Bootstrap Package Installation and Cleanup</H4>

<p>Install  required  application  packages, then you  can  optionally
install  one or more of the major meta-packages suggested by  tasksel.
In January, the Desktop-selection had issues with bluez and mono,
as described in the notes below.</p>

<pre>
apt-get mc tmux vim vim-scripts m4 rsync sshfs elinks mutt

# the bare X11 client-side mininum, with a lightweigth window manager
apt-get icewm xterm

# if you have enough space I also suggest these
apt-get tightvncserver xtightvncviewer 
apt-get lsb-languages lsb-languages-armel lsb-languages-noarch lsb-core

# check for issues and possible look at recommendations
aptitude

cd /
find . -xdev | sort &gt; FIND.chroot
cat FIND.chroot | cpio -o -H crc &gt; /i/chroot-initial-minimal.cpio

# you may wish to install software for basic tasks like desktop or file serving; 
# requires more than just a few minutes, depending on your selection
tasksel

dpkg-reconfigure tzdata

# all package lines should start with ii (properly installed)
dpkg -l | grep -v '^ii'

# has aptitude any issues or problems (press 'g')
aptitude

aptitude clean

# backup the full chroot for the first time 
cd /
find . -xdev | sort &gt; FIND.chroot
cat FIND.chroot | cpio -o -H crc &gt; /i/chroot-initial-final.cpio
</pre>



<br>


<p>Notes</p>
<ul>
<li>run mount and check the mount options for the chroot filesystem: it
should be something along the lines of rw,noatime,barrier=1,data=ordered; otherwise 
change CHROOT.mount or use tune2fs to add default mount options.
<li>Android doesn't supply a working fsck for ext4, see system/xbin/CHROOT.fsck for an example work-around.
<li>if the bluez package is still broken and hangs, just remove 
   /var/lib/dpkg/info/bluez.postinst and run <i>dpkg --configure --all</i>.
<li>mono is not needed, furthermore there were some packaging errors. Uninstall with some effort: 
<i>aptitude install gnote; 
dpkg -i /var/cache/apt/archives/libglib2.0-cil_2.12.10-3_armel.deb;
dpkg -i /var/cache/apt/archives/libgtk2.0-cil_2.12.10-3_armel.deb;
aptitude purge libdbus-glib1.0-cil libdbus1.0-cil libgconf2.0-cil
 libglib2.0-cil libgmime2.4-cil libgtk2.0-cil tomboy libmono-addins-gui0.2-cil 
libmono-addins0.2-cil libmono-i18n-west4.0-cil libmono-i18n4.0-cil libmono-posix4.0-cil
 libmono-sharpzip4.84-cil libmono-system-configuration4.0-cil libmono-system-core4.0-cil
 libmono-system-drawing4.0-cil libmono-system4.0-cil mono-gac mono-runtime; 
aptitude purge mono-runtime libmono-system4.0-cil</i>
<li>other candidates for removal: wicd (wireless connection manager) and bluetooth
    (I've not tested  bluez &amp; friends from within the chroot - the hang in postinstall
    is probably related to some need for udevd or similar. Furthermore any hardware
    access ought to be coordinated with the hardware accesses from the hosting kernel-plus-Android-framework.
    Currently I even do all network management and <i>openvpn</i> use outside of the chroot, 
    excluding just ip route and iptables, so this is uncharted territory)
<li>when removing packages, also consider running <i>deborphan</i> and uninstalling the listed files,
    afterwards run aptitude and press 'g' and look if aptitude suggests additional
    removals from the previously automatically installed packages. Keep what you
    still use (e.g. by pressing i or m) and continue to remove the rest.
<li>to validate checksums of installed files (though not verifying permissions), you can install debsums
    and run debsums_init; this helps in checking for overwritten or corrupted package files.
</ul>



<br><h4>Some customization</H4>



<p>While the scripts in system/xbin are for the outside Android shell,
the  abin directory in the chroot is for in-chroot glue scripts.  Thus
the  chroot-related scripts in system/xbin/CHROOT* often call  scripts
by the same name in abin once inside the chroot. The abin directory in
also  contains CHECK (monitoring), SSHFS (remote file access) and  the
CRON*  files  (enable  some  basic cron-style  scripts  that  schedule
somewhat  sanely despite the unreliable sleep in Android kernels). The
CHROOT scripts in detail:</p>


<ul>
<li><i>CHROOT.available</i> prints the mount state of the chroot
<li><i>CHROOT.fsck</i> is a mere example on how to fsck the chroot from
    within, as the Note doesn't offer fsck.ext4 in the Android shell,
    despite using ext4 filesystems for the Android data.
<li><i>CHROOT.mount</i> mounts all filesystems for the chroot (basically it
    runs the mount statements you already saw above when using the chroot
    for the first time; note that is doesn't check the need to mount
    for each single mountpoints (somewhat ugly/harmless)
<li><b>CHROOT.run</b> either starts a shell in the chroot or runs a command
    and returns the command's return code. It can be used transparently 
    as part of a pipe, and it will try hard to properly translate outside
    full or partial filenames and the current working directory (it mounts the chroot if necessary)
<li><i>CHROOT.start</i> starts cron, dbus and a second sshd (mounts if necessary)
<li><i>CHROOT.startx</i> calls CHROOT.start, otherwise reserved, as I currently
    to aliases like ivnc to start X11 (mounts if necessary)
<li><i>CHROOT.stop</i> only stops the services started by CHROOT.start.
<li><i>CHROOT.umount</i> first calls abin/CHROOT.umount to umount remote 
    filesystems and to stop dbus/cron. The script then tries to
    umount all filesystems of the chroot. Using the -k option 
    attempts a second umount after trying to kill processes 
    using the mountpoint. Ugly, brutal and unreliable. Invoked multiple
    times with -k however, it will succeed.
<li><i>CHROOTED</i> tests if a process is already running in the chroot.
</ul>

<p  class=anno>(I  still  hold  some  hope  of  never  having  to  fix
CHROOT.umount due to never using it again :))</p>



<p>Root  account:  As  I  didn't want to maintain  umpteen  copies  of
profiles,  I keep my own stuff in root/.bash{_aliases,rc}.pj and  just
add  suitable sourcing or updating statements to the other files. That
way, user accounts and <i>terminal ide</i> share this master copy when
sourcing  their own environment. The profiles set a useful prompt  and
window  title  providing  port/pty/user/directory  information,   plus
return  code  in  case of PS1. They also contain aliases  that  shadow
updatedb/locate and use the nightly generated filelists of the backup.
Note  that this abuse of /root requires a not-that-secure <i>chmod 711
/root</i>  - the clean way would have been to put the config files  to
share  into abin and just source them as everyone else does. As usual,
you  can  find  copies of all relevant files in the  example
tarball. </p>

<p>In  setting  up non-system user accounts, you do not want  to  trip
over  Android  IDs. I changed /etc/login.def to use 20000  instead  of
1000  for the values of UID_MIN, GID_MIN. In /etc/adduser.conf, change
FIRST_UID        and        FISRT_GID        similarly.        <i>echo
android_network:x:3003:USERNAME  >>  /etc/group</i> to /etc/group  and
fix  the gshadow structure accordingly. The number 3003 is the  public
secret   number  of  the  group  ID  permitting  network   access   to
non-system(?)  users.  A  search keyword for more detail  on  this  is
ANDROID_PARANOID_NETWORK.</p>

<p>Escaping the chroot can be done by ssh to localhost, as shown below
in  the example using the chroot's host key. If you use ssh-agent  and
passphrase-protected    keys,    invoke   it   as    <i>ssh-agent    >
~/.ssh/env.$(hostname)</i>.</p>

<pre>
# The Great Escape (from chroot to Android shell)

cd /root/.ssh
ln -s /etc/ssh/ssh_host_rsa_key id_rsa
ln -s /etc/ssh/ssh_host_rsa_key.pub id_rsa.pub
cd /data/data/berserker.android.apps.sshdroid/dropbear
ln -s /system/xbin/CHROOT.run x
cd ../home/.ssh
cat /root/.ssh/id_rsa.pub &gt;&gt; authorized_keys
# check permission and owner
ls -l authorized_keys

# now you can run ssh localhost COMMAND from within the chroot
</pre>
<br>

<p>Umlauts  and  locale settings are a bit surprising, as  I  expected
full  UTF8 support everywhere on the Android by default. Umlauts  seem
properly displayed, on delete however they appear as multiple chars. I
still  need to really run DEBIAN as more than a server system to get a
better grip on where and what packages offer locales, as I didn't find
e.g.   en_US.UTF8.  For  the  time  being,  the  sanest   setting   is
<i>LANG=C.UTF-8</i>  (plus  a paranoid <i>LC_COLLATE=C</i>),  as  this
repairs those deletion issue e.g. for ssh logins to the chroot.</p>



<br><H4>Overview of Services and an Automation Example</h4>

<p>Some  applications  require  a  running  dbus:  <i>/etc/init.d/dbus
start</i>.  abin/CHROOT.start  is  intended  to  collect  the  startup
commands for any lightweight daemon or service.</p>

<p>Terminal  multiplexing:  the <i>screen</i> command is broken and hangs  on
detach,  however  <i>tmux</i> is working properly. See  /root/.tmux.conf  for
setting the command key to CTRL-a like with screen.</p>

<p>Virtualization,  e.g. lxc: mostly unsupported (bridging may  also
be unsupported, depending on the kernel).</p>

<p>Basic  cron  services  are  problematic, as  sleep  is  unreliable.
<i>abin/CRON*</i>  offers  an  example  setup to  to  cope  with  this
situation.  The 15min job contains code to catch missed runs of  other
CRON*  scripts  and  tries to resynchronize them with  their  original
window  if their execution was delayed. All you need to do is invoking
<i>x  /abin/CRON.15min</i>  remotely  or with  <i>tasker</i>  or  from
multiple  invocation  sources  at  once (the  jobs  maintain  suitable
locking).  This example can be extended with anacron and more of the
actual  cron  jobs configured in /etc/cron*. The <i>abin/CRON.15min</i>  script  is
currently run by remote root cron in my home WLAN every 15 minutes.</p>

<p>Note  that  I've  also  added  a  repeated  short  period  WAKELOCK
invocation  to  the root cronjob on my Linux box. Thus  sleep  becomes
reliable  in  my home WLAN and the ordinary cron (if started) can  run
normally  during the night. However not-using-the-CPU-by-sleeping  now
costs extra battery, as the Note can no longer suspend to RAM.</p>

<p>Monitoring:  <i>abin/CHECK</i> offers a trivial monitoring  script,
which  can be run by ssh and evaluated remotely (see the root  cronjob
and watch_delta; run every 15 minutes).</p>

<p>Mail  notification and forwarding: The sendmail service is provided
by  the  <i>exim</i> package. Without a setup, exim places  all  local
email  in  the  /var/mail/mail spool file.  <i>abin/CHECK</i>  reports
available  mail, as does <i>system/xbin/TOP</i>. Again have a look  at
the root cronjob file for an example to forward this chroot-local mail
to  an account on the remote Linux box (again every 15 minutes). As  I
don't  want a real mail configuration in a chroot, that's good  enough
for now.</p>

<p>Sending and receiving mail can still be done inside the chroot with
mutt  by using the remote imap/pop/sendmail servers without relying on
a  local sendmail. The example files contain a cut-down mutt setup  as
part  of  my  normal user account in the  chroot  (home/jakobi/.mutt).
There's  also a wrapper in bin/mutt that I use to switch profiles  and
sender  account according to folder contents, which you can ignore  as
long  as you use only a single mail account or define macros to switch
accounts.</p>

<p>Encryption:  For now I only use <i>apg</i> on the Android side  and
gpg  in the chroot for a couple of files. This is more than enough  to
use  vim  to  decrypt a file with some web forum  passwords.  I  would
sugggest  to  only  edit  this  file  on  your  Linux  box  to   avoid
synchronization  issues,  as  patch or unison aren't able  to  analyze
in-file differences between encrypted files.</p>

<p><b>ERRATA: Demonstrate an encrypted loop mount?</b></p>

<p>For   backup   and  synchronization,  revisit  the   example   file
<i>xfer_backup.wrapper.anuurn.local</i>  and  the nightly  backup  job
invoked by remote root cron. Besides running the filelist-based rsync,
it        also       runs       <i>ct_note.update-copies</i>       and
<i>ct_note.update-unison</i>    (all    on    the   Linux    box    in
home/jakobi/bin).  The first clones a subset of the my home  directory
to  the  Note, the second synchronizes a folder tree, with  one  layer
also  following symlinks; both only run when the chroot is mounted  on
the Note. As the Ubuntu 10.4 version of <i>unison</i> was too ancient,
I  installed  a  new build in /usr/local/bin on the  Linux  box  (fast
compile, no trouble at all with ocaml). Remote invocation is as simple
as  <i>DISPLAY= unison /data/unison -batch -auto -servercmd "x unison"
ssh://note//data/unison</i>.</p>

<p>Using    <i>sshd</i>:    I'm    still    using    <i>sshdroid</i>'s
<i>dropbear</i>  as  the  primary  ssh  daemon,  dealing  with  backup
traffic, and everything. The chroot can be accessed from the Linux box
by  running  <i>ssh root@note x COMMAND</i> (e.g. as done  by  unison;
rsync  dislikes the space and requires the chroot-rsync dummy file  in
the  sshdroid/dropbear directory). If you need a real sshd within  the
chroot,  just  run <i>sshd -p PORT &amp;</i> in the  chroot,  possibly
stopping       <i>sshdroid</i>.      This      can      added       to
<i>system/etc/init.d/S99zz_compact_jobs</i>  to  start at boot of  the
Note.</p>

<p>Accessing   remote   filesystems:  Have  a  look  at  the   example
<i>abin/SSHFS</i>  containing  simple mount/umount commands to  permit
access  to  files  on remote computers. This requires the  fuse  sshfs
package.  Sshfs  even offers access to anything mounted on the  remote
side.  <i>SSHFS</i> is intended to also deal with SMB, and NFS (if the
kernel permits), but this is untested.</p>

<p>File serving: Use the usual culprits of ftp, apache and samba as on
any  Linux  box. Don't forget to edit and rerun FW on if you  need  to
open ports in the firewall.</p>


<br><h4>Notes</h4>

<ul>
<li>in  the  long  run, an Android  chroot  setup  is  still  not
comparable  to a native install, that can replace and update the Linux
kernel  as  part of the normal package maintenance. We still  have  to
rely  on  availability of stock components as part of the custom ROM,  as
it's  unlikely that the device blobs will be made available as part of the kernel or library sources.
Furthermore,  vulnerabilities of the outside  Android environment cum kernel still
apply  and  will  only get worse when the device is obsoleted  by  the
maker  (at least Samsung doesn't do this before release to the market,
unlike some other unmentionable manufacturers).
<li>a newer architecture called <b>armhf</b> is being in the works at 
DEBIAN and Ubuntu, which introduces support for more modern CPU features 
and improves FPU support. However the suggested repositories for armhf failed
already in stage one of debootstrap in early January. 
This should prove interesting  in the medium term. When it's entered 'testing', 
just  replace <i>armel</i> with <i>armhf</i> and recreate the chroot. 
<li>even the most program easily hard crashes the Note when using
shared memory: statnet/statnetd, package netdiag. See the next part,
subsection memories, for the work-around, as with X, the shared-memory kernel issues
become fully unavoidable (consider placing a work-around in 
abin/CHROOT.mount to activate depending on a file test of e.g. /i/zz_CHROOT_SHM). 
Don't forget to crash-test when using a different kernel as the bug might no longer occur.

</ul>

<p class=anno>(as of 20120214,
<a href="http://wiki.debian.org/ArmHardFloatChroot">wiki.debian.org/ArmHardFloatChroot</a>
suggests the standard repositories for non-source packages, using 'sid' and 'unreleased'. If FPU support
is indeed the only change, after the final backup and before removing the contents of the chroot to rebuild, it is
tempting to just change the architecture in the apt/sources.list and see what happens. Maybe with first
repeating the debootstrap steps, and then restoring the old /var and most of /etc. 
Do check the release notes first, as I might not be the only one dreaming about an 
armel to armhf migration path :))
 </p>

<br><p><b>Summary:</b>  By  now we have a DEBIAN chroot and can access  it
from   the   Android  shell  interactively  or  as  part  of  a   pipe
(system/xbin/CHROOT.run  aka  x). We are able to  access  remote
files  using  everything  but  NFS (see the  abin/SSHFS  example).  We
also extended the remote automation with limited email checking, monitoring
and folder synchronization.</p>

<!-- ------------------------------------------------------------------------------------- -->
<hr><a href="#toc">(table of contents)</a><hr>
<a name=vnc></a>
<H3>Desktop and X11</H3>



<br><H4>VNC Viewers</H4>

<p>The  idea  of VNC is to split X11 into the server  component  (e.g.
tightvncserver)  and  a  separate,  remote  display  component   (e.g.
vncviewer),  with just exchanging compressed graphic data between the
two  parts.  Comparing  local  VNC  to using  a  remote  X11  display,
transmitting  graphic data is usually less efficient than other  types
of  data, but eliminating remote call round trips to the X11  server
removes all remote call latency, which in itself already
makes  VNC very interesting for non-LAN and higher latency situations.</p>

<p>For  the  chroot  we ignore anything except 2d  display,  keyboard,
mouse.  If you want audio, consider a network-capable audio setup like
<i>pulseaudio</i>,  or have a look at <i>sl4a</i>, to send intents  to
the  Android  framework. If device access isn't blocked by  something,
you could also try accessing the device directly. I also ignore flash;
if  you  need it w/o audio in the chroot, consider installing gnash  -
but  even adobe itself nowadays seems pretty ambivalent towards use of
flash. The idea behind RDP is similar to VNC, and some viewers support
both  protocols, but I didn't check for server components usable in  a
chroot.</p>

<p>A selection of VNC viewer components</p>
<ul>
<li><i>vncviewer</i> - Android app classic (there are multiple other viewers)
<li><i>xvnc</i> - Android app, hardcoded to use its own vncserver
                  installed outside the chroot (useful to reduce the chroot size)
<li>there is also <i>tightvncviewer</i> - the default vncviewer inside the chroot,
    but I'd suggest to use it with only small remote vnc server displays, as
    we'd also need a local vncserver or a remote X11 display (if cascading
    actually works, depending on how the vncviewer accesses the X11 display memory)
</ul>

<p>A selection of VNC server components</p>
<ul>
<li><i>xvnc</i> - the vncserver component is accessible to localhost,
    so use <i>vncviewer localhost:0 -via root@note</i> or establish a 
    port forwarding ssh tunnel and then connect using localhost:
    <i>ssh -L 5909:localhost:5900 -N -f root@note; vncviewer :9</i>.
    For more information, see <a href="http://theqvd.com/trac/wiki/AndroidX11Server">theqvd.com/trac/wiki/AndroidX11Server</a> (the vnc password cannot be changed yet in the Android viewer).
<li><i>tightvncserver</i> - the default vncserver inside the chroot.
</ul>

<p  class=anno>(there are also some interesting ideas on VNC abuse for
e.g.  remote  input devices, most of which seem to work fine at  least
for  single head displays. Consider Android use as  mouse-cum-touchpad
or media remote. There is also - in opposite direction - an app called
<i>androidvnc</i> that exports the Android display to vncviewers.)</p>



<br><h4>Memories</h4>

<p>My current setup reliably "remove-battery"-crashes the Note as soon
as  I use X. I think its a kernel issue, assuming that Google  somehow
messed  up  in  crippling or deconfiguring shared memory. Short  of  a
custom  kernel rebuild, we can only enforce zero shared memory  values
as  a  work-around  as shown below. This hack is part of  the  ivnc  /
ivncapp functions in the root bash setup. Applications that use shared
memory  only for speed-up will run a bit slower. New applications like
chromium-browser that cannot work w/o real shared memory will fail.</p>

<pre>
# test if you crash or if you can get by without
# this ugly trick, in which case don't forget to
# remove it from the ivnc* functions in 
# /root/.bash_aliases.pj

for i in /proc/sys/kernel/shm*;
do
   echo 0 | sudo tee -a $i > /dev/null;
done;
</pre>

<p>Initially,  I  suspected free memory issues, but neither watch  -n1
cat  /proc/meminfo  nor strace indicated anything interesting. If  you
run  into  a  real memory-issue, these are the values I  played  with:
<i>sysctl   -w   vm.min_free_kbytes=80000</i>  or   <i>sync;sleep   2;
/sbin/sysctl  vm.drop_caches=3</i>.  If you have swap,  also  consider
swappiness.  You can also modify /proc/PID/oom_adj or set up limits by
using   cgroups  (search  <i>wrapcgroup</i>  in  my   script-archive).
Returning to my memory suspicion, I have about 300-350M free before X,
which  is enough for a vncserver, xterms, firefox 3.5 and  LibreOffice
with  icewm,  and still leaves enough head room to run extra  commands
and   for   buffers+caches.  In  testing,  I  never   encountered   an
out-of-memory situation.</p>

<p>Still,  being able to add swap space (the second reserved partition
or  just a swap file) would be nice, but my current kernel does permit
swap.  The  fast  internal  flash would be tempting.  But  I'm  a  bit
sceptical  and  thus would only suggest to use the removable  external
flash,  with a swappiness setting to make swap a real last resort  for
the  kernel  just before invoking the out-of-memory-killer.  I  assume
that  swap  write  access patterns will have random,  but  very  heavy
hotspots,  which  would be the worst possible pattern for testing  the
implementation  quality of a only possibly existing flash  translation
layer on sdcards. Given my experiences with bad flash and the frequent
firmware  updates  as  observed for better SSD  devices  from  quality
vendors  in the last few years (indicating firmware fixes to also  the
FTL), I'll for now stick to my paranoia. Don't argue with database use
of  flash - as e.g. transaction logs are the most friendly  sequential
access  pattern  there  is, that is, they do not stress nor  need  the
flash FTL at all.</p>



<br><h4>Testing X</h4>

<p>For  starters, try running <i>xterm</i> on the Note and display the
window   on  your  Linux  box:  e.g.  <i>DISPLAY=&lt;REMOTEDISPLAY&gt;
xterm</i>.  To  work,  the  X-server must listen  to  tcp  and  permit
connections  (Ubuntu's doesn't by default). You may need to run xauth on
the  Linux box and copy the value of the current cookie to the chroot
by   running   xauth  add   &lt;REMOTEDISPLAY&gt;   MIT-MAGIC-COOKIE-1
&lt;COOKIE&gt;.  For this quick test consider to temporarily turn  off
the  firewall: <i>FW off</i> on the Android and maybe add an exception
on  the Linux box (e.g. man ufw on Ubuntu). Don't forget to reactivate
both host-based firewalls when done.</p>

<p>If  you've started a second sshd in the chroot (say port 0815), you
can also run <i>ssh -p 0815 root@note -Y ...</i>, which should include
the  xauth invocation (in contrast to -X) and shouldn't AFAIR  require
the X server to listen to tcp. Ssh tunneling also avoids the FW issues
from above.</p>

<p>Now  invoke vncserver inside the chroot by running the  <i>ivnc</i>
function  as provided in <i>root/.bash_aliases.pj</i> in the examples.
Define  some  VNC  password. Run <i>echo $DISPLAY</i>. Switch  to  the
Linux  Box  and  run <i>vncviewer  &lt;DISPLAY_VALUE_FROM_ECHO&gt;  -via
root@note</i>.  If you don't have the package <i>tightvncviewer</i>, you need to use  ssh
with  port  forwarding. Assuming that the echo  returned  localhost:4,
you'd  say  <i>ssh -L 5909:localhost:5904 -N -f  root@note;  vncviewer
:9</i>. Both examples use ssh for their connection.</p>

<p>As final test, run your vncviewer app on the Android and connect to
the vncserver in the chroot. Using <i>xvnc</i> is identical, but skips
configuring  the  connection in the app and explicitely  starting  the
vncserver  in the chroot. For <i>xnvc</i> use the ivncapp function  in
the chroot after starting X within <i>xvnc</i>.</p>

<p>You  can use the file <i>~/.vnc/xstartup</i> to add commands to X startup,
such  as  starting  the window manager automatically on  starting  the
vncserver.  In  case of troubles, a <i>chmod  755  ~/.vnc/xstartup</i>
might be required. A small example xstartup file:</p>

<pre>
#!/bin/sh
xrdb $HOME/.Xresources
icewm &amp;
sleep 2; xsetroot -solid black; xterm &amp;
/etc/X11/Xsession
</pre>

<p>In  case  of  problems pasting between  host-environment  and  VNC,
consider   running  <i>autocutsel</i>  to  synchronize  cutbuffer   0,
selections  and clipboard. My case of Ubuntu 10.4, Gnome and urxvt was
made  more difficult by something from Gnome partially messing up  the
selection within half a second, and urxvt being more choosy than xterm
doesn't   help.  Workaround  is  modifying  autocutsel  by  adding   a
system(<i>sleep  0.6;xsel  -op|xsel  -ip</i>)  after  copying  to  the
buffer. If you have an idea to find the culprit, drop me a line.</p>



<br><h4>DEBIAN X11 Applications</h4>

<p>Successfully tested applications</p>
<ul>
<li><i>twm, icewm, openbox, lxsession</i> (window managers and graphical environments; 
   my selection is using just <i>icewm</i>)
<li><i>firefox</i> aka <i>iceweasel</i> (browser; from stable, version 3.5)
<li><i>midori, uzbl</i> (browsers; also <i>kazehakase, galeon, epiphany-browser</i>)
<li><i>konqueror, rekonq</i>
<li><i>kwrite, LibreOffice</i> aka <i>OpenOffice</i>
<li><i>xterm</i>
</ul>

<p>Fails: These applications either require shared memory or some daemons
which I did not start or cannot easily start (hald/udevd/...)</p>
<ul>
<li><i>gnome-session, start-kde</i>
<li><i>firefox</i> aka <i>iceweasel</i> (from testing/sid; but this may also be a porting issue)
</ul>

<p>The  described setup with a small window manager like <i>icewm</i> permits
normal  <i>LibreOffice</i>  text  editing,  programming  or  some  light  web
browsing,   even   without  swap:  I've  usually  beyond  350MB   free
(free+buffers+cache)  before starting X, which is enough for X11, some
<i>xterm</i>s, <i>firefox</i> and <i>LibreOffice</i>.</p>

<p>The speed with the current kernel/gingerbread is sufficient even if
I  only used a single CPU during tests. During heavy writes to  flash,
speed  will  suffer  and  I saw short hangs,  especially  in  a  fully
configured  vim with syntax highlighting, while the simple busybox  vi
outside  the  chroot  is  unaffected. Running  huge  resolutions  like
<i>vncserver  -geometry  1920x1600</i>  is  slow  but  works   without
issue.</p>

<p>When encountering the firefox problem, I switched the chroot from a
pure  testing aka wheezy setup to a mixed setup using apt pinning,  see
etc/apt/sources.list   and   etc/apt/preferences.d/personal   in   the
examples. To install a package from a non-default repository in the mixed setup:</p>
 
<pre>
apt-get install &lt;package&gt;/unstable    # prefer testing for resolution  
apt-get -t unstable install &lt;package&gt; # use unstable for resolution
# afterwards consider pinning the package to a specific release in 
# /etc/apt/preferences.d/*
</pre>


<p><b>ERRATA:  Add  a  screenshot of the Note using Xvnc  +  a  shared
vncviewer  on  Linux showing xterms and LibreOffice on the Note?  Both
here and at the top? Add it also to index.phtml.</b></p>


<br><p><b>Summary:</b> This concludes the series and by now you can use an
arbitrary  PC's  vncviewer or putty/ssh setup to connect to your  NOTE
and work locally on your Note in addition to using the Note to copy or
serve  files. The 1GB memory size of the Note permits also use of  X11
apps including Firefox and LibreOffice/OpenOffice.

<p>Excluding  only  the size of the display, the Note already has  the
capabilities  of  newer tablets as well as those of laptops,  with  at
most a little bit of DEBIAN help.</p>

<p  class=anno>And  for  the  pc-less couch potato,  not  desiring  to
implement      the     above     himself,     there's     still     <a href="http://www.ubuntu.com/devices/android">Canonical's    take    on
chroot computing</a> as seen e.g. on the Atrix: "<b>In every dual-core
phone,  there is a PC trying to get out</b>." - Well said,  Canonical!
(with  the HDMI cable, the Note should permit already that kind of use
with  e.g. Xvnc; when it arrives, I'll test using a DVI display and some adapters).</p>

<p><b>ERRATA: another candidate for a photo.</b></p>

<hr><a href="#toc">(table of contents)</a><hr>
<p><center><i>Dear reader, as you now lack the practice of daily weightlifting by
lugging  around  your heavy laptop all the time, I wish you good  luck
and success when taking up some other fitness sport.</i></center></p>
<hr>
<p>Back to the <a href="index.html">Android Section Overview</a>.</p>

<hr>
<p class=anno>
<a href="http://jakobi.github.com/">HOME</a>                                          &nbsp;|&nbsp; 
<a href="http://github.com/jakobi/">GIT Overview</a>          &nbsp;|&nbsp;
Script-Archive:
<a href="/script-archive-doc/">(docs)</a> : 
<a href="http://wiki.github.com/jakobi/script-archive/">(wiki)</a> : 
<a href="http://github.com/jakobi/script-archive">(git)</a>    &nbsp;|&nbsp;
Android:
<a href="http://jakobi.github.com/android-section/">(articles)</a> 
<a href="http://github.com/jakobi/script-archive/tree/master/android">(files)</a> &nbsp;|&nbsp;
...
</p>

<p class=anno>jakobi(at)acm.org, 2012-01 - 2012-03</p>

</BODY>
</HTML>
