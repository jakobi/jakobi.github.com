<HTML>
<HEAD>
<link rel="icon"          href="/favicon.png"/>
<link rel="shortcut icon" href="/favicon.png"/>
<meta name="description" content="Coping with Android - Setup as a Unix Box: survival unix shell chroot debian ubuntu google android tutorial samsung galaxy note vnc X11 xvnc bash office arm armel">
<meta name="keywords" content="coping android setup as unix box survival shell chroot debian ubuntu google tutorial samsung galaxy note vnc xvnc bash office arm armel">
<meta name="author" content="Peter Jakobi">
<TITLE>Coping with Android - Setup as a Unix Box</TITLE>
<style type="text/css"><!--
   .anno { font-size:.8em }
--></style>
<style type="text/css"><!--
   .num { padding-left:1em; text-align:right; nopadding-right:1em}
   .repo{ text-align:center}
   .file{ nopadding-left:1em; font-family:monospace}
.desc{ padding-left:2em}
--></style>
</HEAD>

<BODY style="background-color:#ffffee">

<p class=anno>
<a href="http://jakobi.github.com/">HOME</a>                                          &nbsp;|&nbsp; 
<a href="http://github.com/jakobi/">GIT Overview</a>          &nbsp;|&nbsp;
Script-Archive:
<a href="/script-archive-doc/">(docs)</a> : 
<a href="http://wiki.github.com/jakobi/script-archive/">(wiki)</a> : 
<a href="http://github.com/jakobi/script-archive">(git)</a>    &nbsp;|&nbsp;
Android:
<a href="http://jakobi.github.com/android-section/">(articles)</a> :
<a href="http://github.com/jakobi/script-archive/tree/master/android">(files)</a> &nbsp;|&nbsp;
...
</p>

<H1>Coping with Android - Setup as a Unix Box</H1>

<hr>

<p>Also                  see                  the                   <a href="http://github.com/jakobi/script-archive/tree/master/android">Android
directory  of  the  script-archive</a>.</p>

<p>Besides some scripts, this directory contains a mothballed snapshot
of  my working Android environment intended to complement the articles
below (android-setup-example-files.tgz).</p>

<p>In  it  you  find the scripts for the Android  shell,  a
collection  of static armel binaries, the tree structure of the chroot
on  the  Galaxy note, as well as scripts and configuration files  used
for monitoring, backup, etc from a remote linux server via cron.</p>

<p>Current  versions of the more interesting scripts will be placed in
above   directory   (if   Android-specific)  or   elsewhere   in   the
script-archive (parts of my bash/ksh setup or generic Unix stuff).</p>



<hr>
<a href="01_setup.html"><H2>01 - Setting  up  the Samsung Galaxy Note as a Unix  Box</H2></a>

<p  class=anno><i>(or  at  least as much as we can get away  with,  given
Google's  Linux kernel  patches and dumbed-down kernel configuration)</i></p>

<H3>Table of contents</H3>
<a name=toc></a>
<ul>
<li><a href="#firstlook">A first look at the Note / Web-Resources / Rooting</a>
<li><a href="#shell">Adding Unix Standards to the Android Shell</a>
<li><a href="#chroot">CHROOT and Turning the Android into a First Class LAN Citizen</a>
<li><a href="#vnc">Desktop and X11</a>
</ul>

<p>
State described: Android 2.3.6 (gingerbread)<BR>
Last change: 20120216<BR>
License: CC-BY-SA.
</p>

<p>Most  of the article should also hold for other recent  gingerbread
devices,  the  generics also for all newer Android devices. When  I've
installed  ICS  on the Note (middle 2012 I'd assume), I will  add  ICS
errata at the end of each part.</p>



<hr>
<p>Still polishing notes - version 1 to be online before 20120220</p>



<hr>
<a name=firstlook></a>
<H3>A first look at the Note / Web-Resources / Rooting</H3>

<p>This  article  sketches  a sane setup of GNU/Linux on  an  ordinary
<B>1-GB-RAM   DUAL-CORE  PC</B>  (henceforth  called   the   armel
architecture  Android device <b>Samsung Galaxy Note</b> GT-N7000).

<p>This hardware is more than enough for a moderate desktop pc that is
not  used  for heavy gaming, virtualization or video editing. In  this
article,   I'm   not  interested  in  audio/video   input/output   nor
phone/s-pen/sensor/camera use.</p>


<p>Web Resources of interest:</p>
<ul>
<li><a href="http://www.androidnz.net/2011/12/samsung-galaxy-note-complete-review.html">AndroidNZ review with some app suggestions</a>
<li><a href="http://forum.xda-developers.com/forumdisplay.php?f=1349">XDA Note forum</a>
</ul>


<p>I/O options of the Note include</p>
<ul>
<li>the OTG USB port, which permits to connect
<ul>
<li>the Note to the PC (adb, access to 
    the Note's FAT user filesystems) or
<li>some external USB hardware
    to the Note (Mouse/Keyboard/Memory stick, etc, as long an in-kernel
    driver is available)
<li>the HDMI connection cable (reuses the physical OTG port)
</ul>
<li>acting as either a WLAN-client or a WLAN Access Point
<li>networking over USB
<li>the S-pen - a real wacom-style stylus offering pressure-sensitivity
    and high resolution (not one of those useless iphone-style capacitive 
    finger-tip-replacements; better quality tablet-pc pens work
    on the Note offering both eraser and stylus)
<li>...
</ul>


<p>Flash  considerations:  Choose a <i>quality</i> sdhc microsd
flash, 16  or 32GB. Read speeds for the internal flash are 50+ MB/s and 18MB/s
for  Sandisk.</p>

<p  class=anno>After bad experiences with both Class 10 Transcend  and
Lexar,  I've  now settled on a reliable Sandisk class 4  16GB  microsd
flash.  As Sandisk chooses labels according to the minimum write rate,
it  is nearly as fast as the others. One advantage is that I no longer
find the chroot remounted read-only, as this means to shutdown/restart
the chroot and running fsck (no loss of data though). When switching I
had  a  look at the external sdcard's FAT filesystem and  my  titanium
backup files:  Massive  data corruption. Flash problems may well  have  been
worsened  by  whatever timeout changes&amp;co Google patched  into  the
kernel.</p>



<p>Power  considerations: to save battery,</p>
<ul>
<li>enable automatic battery savings  in Settings.
<li>turn off WLAN and GPS - the location by cell towers is still
pretty exact. 
<li>if necessary, you can also use titanium backup to freeze
some of the more annoying and power hungry apps in your firmware (kies, socialhub).
</ul>

<p>Known pitfalls to avoid:</p>
<ul>
<li><i>adb</i> and using symlinks in Android-side paths - silent failure.
<li>bad flash (in all possible meanings)
<li><i>kies</i> (connectivity suite / flashing windows software provided by Samsung)
<li>use of app2sd: do move all apps to the phone (/data) - the core of
    the Android framework has <B>MAJOR PROBLEMS</B> with apps on sdcards,
    upto and including hanging in a boot-loop (recover by full wipe or
    by <i>adb shell</i> from the PC and removing any packages on the sdcards;
    access by ssh with sshdroid is not possible).
</ul>



<h4>The Whys of Rooting</H4>

Besides  getting faster access to upstream security and bug fixes than
by  waiting for something to trickle down rom Google to Hardware Maker
to Provider to OTA distribution, rooting enables more options for

<ul>
<li>backup/restore
<li>battery management
<li>privacy (<i>lbe privacy guard</i>, <i>aspotcat</i>, ...; iptables-based "personal" outbound firewalls)
<li>routing (improved tethering and intelligent "routing" at ip route/iptables level)
<li>security (<i>lookout</i>, <i>avast</i>; the ability to create a real iptables-based inbound packet-filter/firewall)
<li>access to non-Android programs, for the Android shell or for a chroot
    maybe containing a full DEBIAN or Ubuntu.
</ul>

Depending  on how you root the device, the flash counter may  increase
(though that <a href="http://forum.xda-developers.com/showthread.php?t=1354888">301K
resistor  field testing jig</a> may help). But in case of mailing  in
the  device for service, you need to reflash a stock firmware anyway. In  summary:
so what.




<h4>A Sabbatical for Research</h4>

<p>ROMs  are very device specific, so Android ecosystem and  community
are  <i>extremely fragmented</i>: <b>Good community support and custom
roms  are IMHO a pre-requirement when buying Android devices</b>. Some
custom  roms  reuse  stock  kernels, some  use  custom  kernel  builds
(usually   based   on  Android  Open  Source  Project/AOSP;   e.g.
cyanogenmod).</p>

<p   class=anno>Bad  makers  or  lack  of  community  lead  to   early
obsolescence  of the device and wasted money (consider the  disastrous
Motorola  Milestone).  Depending on the number of non-standard  chips,
various firmware-blobs might be required to get a fully working kernel
/  firmware. With some makers not even supporting devices, the initial
release  kernel might well be the only Linux kernel ever working on  a
device  (again the Milestone example). This will also worsen community
support  and  shorten  availability  of community  firmware  for  this
maker's devices (which has to reuse the old buggy kernel). <b>Some</b>
of  this  is visible for the Note as well: the unofficial  CM9  builds
still lack blobs for camera and accelerated display.</p>

<ul>
<li><a href="http://forum.xda-developers.com/forumdisplay.php?f=1349">XDA Note forum</a>
<li><a href="http://sammobile.com" <a>Sammobile</a> (aka samfirmware.com aka samsung-firmwares.com; also contains stock images for reflashing)
<li><a href="http://forum.xda-developers.com/showthread.php?t=1424997">XDA: stock rom list and rom overview</a>
<li><a href="http://cyanogenmod.com">Cyanogenmod</a> and <a href="http://teamhacksung.org/wiki/index.php/Main_Page">teamhacksung</a> (only preliminary unofficial CM7 and CM9 builds for the Note, still lacking some blobs; <a href="http://forum.xda-developers.com/showthread.php?t=1423795&page=52">XDA: cm9</a>)
<li>ROM: <a href="http://forum.xda-developers.com/showthread.php?t=1331784">XDA: Chainfire's CFROOT with CWM (clockworkmod)</a>
<li>ROM: <a href="http://forum.xda-developers.com/showthread.php?t=1352945">Sheeprom</a> by Frank_M aka Riversource
<li>ROM: <a href="http://forum.xda-developers.com/showthread.php?t=1424401">Chris_X roms</a> by Chris_X
<li>Other mentions were villain rom and <a href="http://forum.xda-developers.com/showthread.php?t=1380284">XDA: rocket v13</a>.
</ul>

<p class=anno>(state 201112-201201, Note gingerbread ROMs)</p>



<h4>Pre-Flashing Checklist</h4>


<ul>
<li>create and validate a backup suitable to recover ALL of your device from a 
    barebones custom rom install.
<ul>
   <li>if not yet installed, do install <i>titanium backup</i> from market.
   <li>ensure that you have a copy of the /efs contents somewhere (imei, etc)
   <li>consider backups of /mnt/sdcard and /mnt/external_sd.
   <li>consider a backup of /data, even if only <i>tar cf /sdcard/data0.tar /data</i>
   <li>consider using titanium backup to backup user/system apps and data.
   <li>validate your backup!
   <li>consider using cfroot/cwm to do a backup from the recovery rom:
       way faster than titanium to recover the previous state, but not
       that useful on restoring user data into a new custom ROM, as it
       is easy to restore "too much".
   <li>consider copying the backup to your PC! If that happens 
       automatically as part of a nightly backup run, do manually check that copy!
</ul>
<li>ensure that USB-debugging is enabled and adb shell still works
<li>ensure a high battery level
</ul>


<h4>The Way of Rooting (Tourist Travel Sketch, with dog-eared threads)</h4>

<p>At the end of the research phase, you should have selected a target
custom  rom, and maybe one or more intermediate steps if you start out
with  a stock rom. In my case the sequence led from stock back in time
to  a full install of the older KJ1 with CFROOT/CWM, and then  forward
again  to  Chris_X 4lph4 ROMs offering KL8 using the AbyssNote  2.6.35
kernel.</p>

<p><i>Stock to Chainfire KJ1 including the modified factoryfs</i> (see
<a href="http://forum.xda-developers.com/showthread.php?t=1331784">posting
1+2</a>).  If  your  rom doesn't offer CFROOT/CWM, you first  need  to
install  a version of ODIN on Windows that lists the Note as supported
(v3  version 1.83 or 1.85 was the one I found - there doesn't seem  to
be any official home page or author, nor any sane version numbering; a
list        if       provided       e.g.       in       this        <a href="http://droidangel.blogspot.com/2011/05/odin-multi-downloader-flasher-program.html">overview</a>).
For  Linux,  Heimdall  might  work (untested). To set  the  Note  into
download  mode,  use lower-vol + home + power and connect to USB.  For
more detail, check the XDA threads for your selected ROM.</p>

<p><i>Chainfire     KJ1     to    Chris_X    4lph4</i>     (see     <a href="http://forum.xda-developers.com/showthread.php?t=1424401">XDA</a>).
As  we  now  have CFROOT/CWM available, this step no  longer  requires
Windows  and Odin. I repeated this step once to go to a newer ROM from
Chris,  currently  the v1.0.5 from early January which is very  stable
(excluding  Google's  carefully  prepared pitfalls  concerning  shared
memory  and  system_server  vs app2sd). 

<p  class=anno>As of mid February, Chris is at v1.7.</p>

<p  class=anno>I  will  follow  Chris once in a  while  until  ICS  is
available  as a CFROOT/CWM supported rom. In the long run, I'll expect
to end up on CM9 or newer.</p>

<p>Notes:</p>
<ul>
<li>entering recovery: CWM application or upper vol + home + power
<li>using CWM to delete the contents of the cache partition and dalvik
cache  is  a  good  idea (the last adds about  15min  to  the  initial
boot).
<li>you may need to be selective in restoring titanium backups: browser 
and market may have different versions, so restoring user data may lead to force crashes.
This fragility is why Chris strongly requires full wipes as part of the install. Note
that restoring 300 user apps takes a whee bit of time.
<li>if you made a CWM Backup before flashing, do not use it as-is from CWM
recovery, as you'd restore the previous state and fully or partially undo
a successful flashing. Though it's perfect to undo a bad flashing or to go back
from testing another ROM.
<li>consider turning off OTA updates (Settings -&gt; About Phone -&gt; 
Software updates). While still pretty rare, Samsung is one of the select
few Android makers that actually publish ROM updates.
</ul>



<h4>Post-Flashing Checklist</H4>

<ul>
<li>check /data/system/uiderrors.txt (chown/chgrp as required as root or try CFROOT's
    fix permissions from the recovery shell; uninstalling all affected apps is another
    option via market or <i>pm uninstall</i> in the shell)
<li>optional: consider doing an immediate fresh-custom-ROM-install backup, maybe 
    as simple as <i>tar cf /sdcard/data1.tar /data</i>, but don't overwrite any of your backups.
<li>optional: copy the backups from the PC back to the Note
<li>(selective) restore of applications (and possibly data) using <i>titanium backup</i>.
<li>use <i>zdbox</i> to move any apps on sdcard back to the phone (there are preference
    settings, but some apps get still always installed to sdcard)
<li>check /data/system/uiderrors.txt again
<li>skim through the Android's settings menu:
<ul>
<li>fix language settings, reenable keyboards(?)
<li>application -&gt; usb debugging still enabled (<i>adb shell</i> command from PC still working?)
<li>power settings
<li>phone: disable OTA software updates
<li>...
</ul>
<li>restore your widgets (<i>quick agenda</i>, <i>floatmemo</i>, <i>coolapps</i>)
<li>check apps that should run on boot / have active schedules (in my case: <i>titanium backup</i>, <i>tasker</i>, 
    <i>lookout</i>, <i>LBE privacy guard</i>, <i>ring guard</i>, <i>smart task switcher</i>)
<li>check <i>terminal ide</i> and root access
<li>from the PC, check the SDK's <i>adb shell</i> access as well as ssh access via <i>sshdroid</i>
<li>check logcat in the shell (is there a need to run insmod /lib/modules/logger.ko or similar?)
<li>rerun sl4a installers (perl apk file is e.g. the installer/uninstaller for perl)
<li>fix your ring and notification tones
<li>check apps (e.g. by <i>titanium backup</i> or by ls /system/app) for applications to 
    disable (<i>titanium backup</i>: freeze)
<li>optional: restore your own modifications to the Android shell and to 
    the <i>terminal ide</i> environment (run INSTALL from part two to recover Android shell 
    modifications, scripts, binaries and symlinks; if lost, do recover the root account 
    for <i>terminal ide</i> from backup)
<li>optional: if already installed: check mc, bash, vi/vim in the shell and in <i>terminal ide</i>
<li>optional: check the availability and functionality of the chroot setup
</ul>

<p>Finally</p>
<ul>
<li>restore /etc/openvpn from the backup (for now, this is intentioanally skipped by INSTALL)
<li>check /data/system/uiderrors.txt again
<li>make  a new backup and copy that to the PC (not  replacing your old one from pre-flash)
</ul>


<h4>Software</h4>

<p>1. Nice to have market apps to improve on Android graphical offerings:</p>
<ul>
<li><i>apg</i> (an Android frontend for pgp/gpg encrypted files)
<li><i>aspotcat</i>, <i>lookout</i> or <i>avast</i>, <i>lbe privacy guard</i> (security, permissions, receivers, intents)
<li><i>clipper</i>, <i>clip ninja</i>, <i>floatmemo</i> (without a window system, we need help to transfer data between apps)
<li><i>clocksync</i> (to keep your clock in sync with NTP)
<li><i>coolapps</i> (system load widget and much more)
<li><i>jota</i> (nice text editor)
<li><i>k9</i> (nice mailer)
<li><i>mobile odin</i> (custom ROM flasher, see also the cwm app, that should be part of of the custom ROM)
<li><i>printbot</i>, <i>scanthing</i> (printing and scanning, with OCR via update to google docs; also consider adding some
    office suite app.
<li><i>ringguard</i> (don't accidentally change ring tone loudness)
<li><i>smart taskswitcher</i>, <i>task manager</i>
<li><i>tasker</i> (programmable android event handling, can substitute for cron, can turn on/off WLAN depending on location, etc)
<li><i>terminal emulator</i>
<li><i>zdbox</i> (task killing, moving apps from sdcard to phone)
</ul>

<p  class=anno>(voice recognition and more than word-level handwriting
recognition aren't quite there yet in gingerbread)</p>


<p>2. Required market apps for the rest of this article:</p>
<ul>
<li><i>busybox installer</i> (stericson, use /system/xbin as installation path)
<li><i>connectbot</i> (use ssh to connect to remote systems)
<li><i>file expert</i> or any other filemanager capable of accessing non-sdcard directories
<li><i>sshdroid</i> (permit incoming ssh connections, dropbear-based)
<li><i>superuser</i> (usually part of the custom firmware we install)
<li><i>terminal ide</i> (a pretty complete unix user space for the Android shell)
<li><i>titanium backup</i> (backup and restore apps, also offers dealing with offending (firmware) apps)
<li><i>xvnc</i> or <i>vnc viewer</i>
<li>mostly optional: <a href="http://code.google.com/p/android-scripting/">sl4a and perl</a> (perl/python/lua wrapper
    examples are availble for use of the languages in the Android shell; some of my scripts may require perl)
</ul>

<p class=anno>(there  also  are one or two apps that may simplify setting  up  the
chroot   for  sections  3  and  4  of  this  article  (market:   Linux
installer))</p>


<p>3. PC-side applications</p>
<ul>
<li><i>adb</i> (in the <a href="http://developer.android.com/sdk">Android SDK</a>, tools directory)
</ul>


<p><b>Summary:</b>  By now you've a rooted Android device, seen a  few
XDA support threads as well as some checklists for use when reflashing
the ROM.</p>




<!-- ------------------------------------------------------------------------------------- -->
<hr><a href="#toc">(table of contents)</a><hr>
<a name=shell></a>
<H3>Adding Unix Standards to the Android Shell</H3>

<p>Do run and setup each of <i>busybox installer</i>, <i>sshdroid</i>, <i>terminal ide</i>,
<i>titanium  backup</i> and <i>superuser</i> (probably already activated in custom ROMs). From now on, I assume
that</p>

<ul>
<li>you've a Linux PC available (if you want to look at the automation examples incl. nightly backup and monitoring)
<li>grep, sh, etc is available in /system/xbin (<i>stericson busybox installer</i>)
<li>running su, then id in <i>terminal ide</i> show either root or the numerical id 0 (otherwise 
    verify <i>superuser</i>; note that this su is not the real Linux su)
<li>you can run <i>shh root@&lt;WLAN IP of your device&gt;</i> to start an android shell using the dropbear daemon (check <i>sshdroid</i>; 
    your public key goes to /data/data/berserker.android.apps.sshdroid/.ssh/authorized_keys)
</ul>

Further assumptions and settings of my setup (please also check in case of errors):
<ul>
<li>run <i>mount -orw,remount /system</i> as necessary in case of errors 
<li>hostname of the Note is note: <i>hostname note; echo "127.0.0.1 note.compact note "$(getprop net.hostname)" localhost" >> /etc/hosts</i>
<li>DNS lookup is provider-independent: <i>(echo nameserver 8.8.8.8; echo nameserver 8.8.4.4) > /etc/resolv.conf</i>, see also the setprop statements in VPN.
<li>If you see a hardcoded WLAN IP of 192.168.2.114, please replace it with your own Note's WLAN IP. 
<li>/s is a symlink to /mnt/sdcard/COMPACT/setup.
<li>the example home/jakobi/bin/shell/android.func defines some shell aliases to interact with the
    Note from a Linux box: inote, notescp, notessh
</ul>

<p>Please unpack a copy of the <a href="https://github.com/jakobi/script-archive/blob/master/android/android-setup-example-files.tgz?raw=true">example files</a> somewhere (though <b>not in / on your Note</b>). You can check the  <a href="http://github.com/jakobi/script-archive/tree/master/android">Android directory</a> for updated versions, as I will only very infrequently update the tarball. Host.note is an extract of the Note's files, while host.anuurn contains some files from the Linux PC.</p>

<p>If you intend to use my INSTALL script to modify your Android shell
setup,  only  files  below /s (or /mnt/sdcard/COMPACT/setup)  will  be
considered  by INSTALL, so please start with empty /s/data, /s/system,
and  /s/root-tarballs  directories and simply modify and add  scripts,
tarballs  and  configuration, as you proceed through the  article  and
find interesting tidbits. In the example files, the location should be
host.note/mnt/sdcard/COMPACT/setup/INSTALL.</p>


<p><b>ERRATA: rebuild tarball and update INSTALL: old PATH</b></p>


<p>Now that we've taken care of the basics and have access to a rooted
Note,  let's get to the more interesting parts of this article.</p>



<h4>Differences  from  a real Linux system</h4>

libc and its most visible problem: Google reinvented an embedded small
libc  clone  by  the name of bionic, with together  with  the  Android
framework  implements  DNS in a non-standard way. This leads  to  some
confusion  in porting as whether to look at the output of setprop  and
make  quite a few code modifications or just look at the files in /etc
and  hope  that  something (the user...) keeps them in sync  with  the
framework's  properties (setprop/getprop shell command). For  busybox,
the  stericson  version you installed into /system/xbin does  use  DNS
properly,  while  the  versions from <i>sshdroid</i>  and  <i>terminal
ide</i>  do  not and only permit raw IP addresses. I defined an  alias
iresolver to reorder PATH to enable DNS-related shell commands.</p>

<p>Google   also   reinvented  the  wheel  with  logcat.  Again   with
interesting  effects:  they didn't mangle all parts of the kernel,  so
many  kernel messages never make it to logcat at all. Worse, there  is
no  syslog/klog,  and  messages at best can be seen for a  very  short
period  in a much too noise dmesg output. The lost messages include so
uninteresting topics such as logged packets from user-created iptables
rules.   However,  messages  about  filesystem  data  corruption   are
similarly mistreated. Which just happens to be a <b>severe reliability
issue</b>.  Note that there's nothing in a chroot that can work around
this problem.</p>

<p class=anno>(logcat use may require insmod /lib/modules/logger.ko)</a>

<p>Other   things  that  may  be  unavailable:  Shared  memory.  Again
improperly removed/unconfigured, leading to crashes and the X11 shared
memory  workaround  reported later on. NFS client or  server  support.
The ability to use swap space or swap to file.</p>

<p>The  low power portions of the Google patches neglects to  properly
fix   sleep.   So   without   active  wake_locks   to   avoid   system
suspend-to-ram,  even a one second sleep is completely unreliable  and
may  have  a duration of a few minutes. Large sleeps are affected  way
worse:  Sleeps  aren't ended when the system activates again  and  the
real  time  is  after the intended end of sleep. Thus  a  chroot  cron
becomes  pretty  much unusable without constantly  maintaining  active
wakelocks.    See    the   example   <i>system/xbin/WAKELOCK</i>    to
set/clear/list wake locks.</p>

<p  class=anno>(see e.g. <a href="http://lwn.net/Articles/318611/">LWN:
Wakelocks and the embedded problem</a> - inconsiderate patches such as
these  with  heavy collaterate damage do have a hard time to  make  it
upstream into the Linux kernel sources)</p>



<h4>Notes on Functionality and Commands</h4>

<p>Editing  text:  a  simple vi clone is part of busybox, and  can  be
found  in /system/xbin, and as part of <i>sshdroid</i> and <i>terminal
ide</i>.  A real port of vim is available with <i>terminal ide</i>. On
the graphical side, consider <i>jota</i></p>

<p>I  found  a few working static armel binaries for bash, mc,  rsync,
strace,  tcpdump, and wget. They are included in the example files  in
system/xbin.  Bash and mc are also included with <i>terminal  ide</i>,
but  the terminal-ide mc version lacks sub-shell support. A simplified
wget is also part of busybox.</p>

<p>The shell: sh is part of both busybox and toolbox. As I've run into
a  slew of toolbox bugs, I'd suggest to use /system/xbin/sh. Or  bash,
as mentioned in the previous paragraph. (consider a symlink /bin/bash,
but it's probably better to avoid /bin/sh). Don't mix GNU programs and
busybox  programs within a single pipe hosted by busybox sh  (spurious
output write errors between pipe stages).</p>

<p>To  use  Perl  in the shell, see the system/xbin/perl  example  and
install      sl4a      and      the     perl     apk      from      <a href="http://code.google.com/p/android-scripting/">Scripting Languages
for  Android</a>.  Python  and lua wrappers are also included,  but  I
don't  really use them. In case of <i>sl4a</i> crashes, uninstall  and
reinstall  the  crashing  language.  Consider  creating  the   symlink
/usr/bin/perl  and  adding  /usr/bin  to the  PATH  to  permit  normal
invocation.</p>

<p  class=anno>To use the Android GUI in say ssh scripts, you need the
access  data  from a running "host environment" like <i>sl4a</i>:  run
the  shell  in <i>sl4a</i> and redirect the output of set to  a  file.
Keep open <i>sl4a</i> and set suitable environment variables according
to  the captured output. Maybe also of interest/possibly working as  a
"host":  <i>tasker</i>  and  <i>taskbomb</i> with its  script  support
package (all 3 on market).</p>

<p>Script examples:</p>
<ul>
<li>CHROOT.run (often aliased to x); starts a shell in the chroot or
    run chroot commands as part of a pipe. But more on this will
    have to wait until part 3.
<li>psg is a <i>ps -ef|grep</i> style alias. It also offers to list
    non-standard jobs of interest, or to classify processes as kernel / Android 
    framework/Java / shell or chroot. As busybox doesn't implement ps -ef,
    the script uses busybox top as base.
<li>TOP augments to output of TOP with various Android specific information
    from watching df, checking that interesting filesystems are still read-write,
    to battery status and cpu frequencies. No interactive top command keys possible.
<li>WAKELOCK is a convenient wrapper used to setup/discard and list wake locks, 
    and used in many of the other scripts.
</ul>



<h4>Treasure Trove Terminal IDE</h4>

<p>(there's no need to use java and the ide to really profit from installing and using <i>terminal ide</i>)</p>

<p><i>terminal  ide</i>  aims to attempt to make standard  Unix  setup
available  to permit working with vim and java, thus the <i>IDE in the
terminal</i>  name. This provides the best working environment for the
android shell outside of a chroot. It offers e.g.</p>

<ul>
<li>bash (this lacks subshell/jobs support)
<li>busybox (though lacking DNS-resolving; see the iresolver function or
    temporarily prepend /system/xbin to the PATH)
<li>mc   (this lacks subshell support, consider running the 
   system/xbin/mc binary from the example files or the chroot's <i>x mc -a</i>.
<li>tmux (screen-style terminal multiplexer, configured to use CTRL-a as command key)
<li>vim (_the_ editor; way better than vi, and much better than the busybox vi subset)
</ul>

<p>With  some  coaxing in the form of custom profiles and  the  script
TERMIDE  (I  usually  alias it to t), the environment is  also  usable
outside   the   app,   e.g.   from  ssh  or   for   root.   See   both
data/data/com.spartacusrex.spartacuside/files/root                 and
data/data/com.spartacusrex.spartacuside/files.  The  example  profiles
will  also  clone two bash files from the chroot's root  account  into
data/data/com.spartacusrex.spartacuside/files/root   to   maintain   a
single  environment  inside  and  outside of the  chroot,  inside  the
<i>terminal  ide</i> app and outside, for both the <i>terminal ide</i>
user account or for root. Running the app is not required.</p>

<p>Notes</p>
<ul>
<li>a <i>terminal ide</i> bash may block attempts  to  run
    <i>mount  -oro,remount /system</i>. /s/INSTALL reliably triggers  that issue.
<li>injecting root profiles into files of another Android app in /data/data
    isn't the sanest thing to do. But it works, and the the 
    normal <i>terminal ide</i> user accounts needs similar settings anyway. Take
    a look in case of restoring with titanium backup, but other than mc 
    creating a new profile, nothing should happen. Wrt security, the Android
    setup is single-user in the first place, abusing id's for the purpose
    of isolating apps against each other. Given that we need to
    run <i>terminal ide</i> binaries as root anyway, there's no additional risk to consider.
<li>a fully configured vim with syntax highlighting might hang for when
    the sdcard is busy with heavy writing. For tiny edits,
    just ssh on the machine and use the busybox version.
</ul>




<h4>Networking</h4>

<p>Browsing:  some  providers  like to mangle httml pages  or  provide
different  resolution  images and embed extra javascript in pages.  In
case  of the German Telekom, most of this nonsense can be disabled  by
<a href="http://speed.telekom.de/laptop_confirmation.php?u=">speed.telekom.de/laptop_confirmation.php?u=</a>.
This  behaviour  was questionable when it started and with  increasing
network  speed  and display sizes, it doesn't get more  reasonable  at
all.</p>

<p>Using   ssh:   Ssh-client  and  scp  can  be  found  as   part   of
<i>sshdroid</i> including sftp server and scp. Another copy is offered
by   <i>terminal   ide</i>.   A  real  openssh  build   is   part   of
<i>sshtunnel</i>,  also  named  sshtunnel. As  android  app,  consider
<i>connectbot</i>.  Note  that I was unable to trivially port  an  old
ssh-based  tunnel trick of mine, as some ssh options are not supported
by any of these.</p>

<p>Using   sshd:  As  ssh-server  I  use  dropbear  as   provided   by
<i>sshdroid</i> (<i>terminal ide</i> again provides a second copy) and
only  rarely run a second sshd -p <portnumber> on an alternate port in
the         chroot.         See         the         profile         in
data/data/berserker.android.apps.sshdroid.  Adding  keys with the  GUI
didn't  always  work,  so place them in  home/.ssh/authorized_keys  in
above directory.</p>

<p>Using  socks:  <i>proxydroid</i>,  <i>sshtunnel</i>  and   <i>orbot
(TOR)</i>-  iptables-based  forwarding  of http/https  requests  to  a
server-based  based socks daemon. If you want to setup your own  socks
daemon,  take  a look at the hpsockd.conf in the examples  (as  tested
once on Ubuntu 10.4).</p>

<p><b>ERRATA: add hpsockd.conf to examples</b></p>

<p>Iptables  is  hopefully part of your custom ROM. Iptables  is  also
part  of <i>proxydroid</i>, <i>sshtunnel</i> and <i>orbot</i> packages
from  market. <i>lbe privacy guard</i> or any of the personal firewall
tools should also contain or offer to install a copy iptables.</p>

<p>Rsync:  I've  stumbled  upon  a static  compile  (included  in  the
examples)   which  is  as  simple  to  use  as  <i>rsync  -a  --delete
root@note:/DIR  /HOSTDIR</i>.  For  a  backup  solution,  check   e.g.
rsync-backup.  Some  of  the  rsync-related market  apps  should  also
provide suitable rsync binaries.</p>

<p  class=anno>I  think  that  for now I will want to  fall  short  of
providing  the  promised  automated nightly backup  solution  (if  you
silently  add  a  'simple'  in there). In the meantime,  the  files  I
actually  use  in my backup are part of the example files.  My  backup
setup  is  bit  older  than  rsync-backup  and  centers  on  filtering
filelists.  As  invoked for the Note, it uses also rsync for copy  and
cleanup  of removed files, and it also keeps numbered daily/weekly/...
snapshots.              Execution             starts              with
home/jakobi/bin/xfer_backup.wrapper.anuurn.local,  which is invoked by
a  nightly  root cron job (ensure that <i>titanium backup</i>  on  the
Note  is finished first). Furthermore check the copied titanium backup
location  on  the  host  after  the  first  run  -  I  initially  used
/mnt/sdcard/external_sd/BAK,   however   a  directory  like   BAK   is
automatically excluded in my setup...</p>

<p>Using  a  VPN: OpenVPN and tun.ko is hopefully already part of  the
custom  ROM (or in case of tun.ko optionally also a part of the kernel
- otherwise add a insmod /lib/modules/tun.ko or similar; there also is
a  <i>tun.ko  installer</i>  on the market as well  as  an  <i>openvpn
installer</i>).  The  example  files  show  a  working   shared-secret
openvpn-pair example:

<ul>
<li>system/xbin/VPN* (with VPN to start the VPN, VPN-ALL to tunnel all
    traffic over the VPN including internet traffic and VPN-NONE for the
    opposite. To end the session, run VPN-NONE and maybe pkill openvpn).
<li>the etc/openvpn files for both the Linux host and the Note (/etc/vpn is NOT handled by INSTALL)
<li>see also the settings menu, which offers additional VPN options.
</ul>


<p><b>ERRATA: w/o jump</b></p>

<p>Some  graphical apps using VNC/RDP to view remote computers:  there
are  various  VNC  apps available, including  <i>vnc  viewer</i>,  and
<i>Pocketcloud</i>.  For  the  opposite direction, to  view  the  Note
desktop   using   VNC,   consider  <i>androidVNC</i>.</p>

<p  class=anno>(the Note's resolution is great, but my eye isn't  upto
to  the  Note's  300dpi,  so vnc use requires  zooming.  There's  also
a multihead  issue: no vnc app was up to deal with a multihead  display
of  two different sized monitors -&gt; run a a (smaller) vncserver  on
the remote host)</p>

<p>There's  also <i>Xvnc</i> which combines a vnc viewer hardwired  to
connect  to  a  locally running vnc server which acts  as  X11  server
(armel  binaries  included). If you've space issues when creating  the
chroot  in part 4, Xvnc is very convenient to skip installing most  of
X11  inside  the  chroot  -  merely  run  <i>aptitude  install   xterm
icewm</i>.</p>

<p>As  we install a chroot soon, I'm not covering graphical apps  that
access  remote  files  or offer access to remote files.  As  for  NFS,
without  kernel support, you cannot neither access NFS files nor offer
them.</p>

<p  class=anno>Unless you have access to a Linux box elsewhere and run
fuse sshfs in the direction you want to: The Linux box can then either
offer  the  Note's files per NFS or forward contents of NFS mounts  to
the  Note  (chroot  required  for  this  direction;  see  the  example
abin/SSHFS script later on).</p>

<p>For connecting to a WLAN and AP mode (WLAN tethering), just use the
settings  menu on the Note and e.g. network manager on the Linux  box.
For  tethering via USB, connect the Note and select USB tethering.  On
the  Linux box run <i>modprobe usbnet</i>, maybe also  <i>dhclient</i>
and  have a look at usb0. I didn't test inverse tethering (making  the
Note  use the Linux Box's connection to the internet), but on a  short
search  I found 11 pretty dissimilar sketches from using ppp or ssh or
adb with portforwarding to bridging.</p>

<p>Network security</p>
<ul>
<li>Antivirus  is a prime requirement. <i>avast</i> and  <i>lookout</i> on
the graphical app side sound sane and add some device-location and anti-theft features.
<li><i>Personal  firewalls</i> or rather <i>iptables-based outbound packet filters</i>
control outbound packages and are used to augment (<i>LBE  privacy  guard</i>)  or 
substitute  for  actual application  permission management.  Some  antivirus  apps
also include  this  feature  when running on a rooted Note (<i>avast</i>). Note
that this is only slightly more capable than your ordinary Windows personal firewall - 
even something as basic as a mere DNS name lookup can leak arbitrary information to a
selected target host. "Personal firewalls" are also not quite the right place 
to block apps for ideas like battery saving.
<li><i>system/xbin/FW</i>: I didn't find any <b>real firewall</b> that deals with inbound packages.
There are some inbound call and sms blockers, but one of the real basics of
network security doesn't seem to exist for Google and every Android developper.
See system/xbin/FW for a script to create and destroy a firewall. It is loosely
based on the rules as created by ufw on an Ubuntu box. Note that we cannot
use syslog for logging, so for rule testing, you need to run <i>dmesg|grep ...</i>
to see output for logged packets.
</ul>



<p><b>Summary:</b>  By  now we have a somewhat usable  and  moderately
comfortable  Android  shell.  We  have basic  networking  commands  to
connect  remote  servers and we we can run perl scripts.  An  external
host  can  be used to run shell commands on the Note or run  rsync  to
create  a  file  backup of the Note. We also have seen  an  automation
example consisting of a remote triggered backup. You also have a real
Linux networking setup and access to a real classic inbound firewall (FW).</p>




<!-- ------------------------------------------------------------------------------------- -->
<hr><a href="#toc">(table of contents)</a><hr>
<a name=chroot></a>
<H3>CHROOT and Turning the Android into a First Class LAN Citizen</H3>


<p>First let me start by pointing back to the warning against bad flash.</p>



<h4>Setting up the filesystems</h4>

<p>Let  us  create  a  SSD-style 4MB-aligned  partitioning  scheme  by
starting  the first partition at 8192 and have all partitions start at
sector   numbers  divisible  by  8192  (that  might  offer  a   slight
improvement  also with sdcard; optional).</p>

<p>Sizing:  For a basic desktop install plus build-essentials  install
and  some file serving, you need about 3.5GB + 2GB to install. A  rule
of  thumb  might  be to clean /var, /tmp and run aptitude  clean,  and
double  that size to add some reserve to permit upgrades, that is  for
me   at  least  7GB.  Without  any  desktop  task,  you  should  still
comfortably  fit  in  in a slightly less-than-4GB  file  container  on
either  the  internal  or external sdcard, however the  required  loop
mount  adds some overhead and I already had some data loss on the  old
external  sdcard, so I'd argue for a direct ext4 setup.</p>

<p>Put  the  sdcard to use in a card reader on your  Linux  box  and
umount any automatically mounted filesystems from the sdcard. Then run
fdisk and create the filesystems.</p>

<pre>
# avoid problems on Ubuntu 10.4 with recent kernels
echo 0    &gt; /sys/block/sdd/queue/rotational
echo noop &gt; /sys/block/sdd/queue/scheduler

fdisk DEVICE                                                      # /dev/sdd for me
# press c and u, and define partitions that look like these

#...
#Units = sectors of 1 * 512 = 512 bytes
#...
#  Device Boot      Start         End      Blocks   Id  System
#/dev/sdd1            8192     8880127     4435968   83  Linux       # type c aka fat32
#Partition 1 does not end on cylinder boundary.                      # &lt;--- ignore this
#/dev/sdd2         8880128    27754495     9437184   83  Linux       # chroot partition
#/dev/sdd3        27754496    29433855      839680   83  Linux       # reserved home/var
#/dev/sdd4        29433856    31116287      841216   83  Linux       # reserved, maybe also swap

# type p to print and check; type w if everything is ok to write/quit fdisk.

mkfs.vfat -n note2 /dev/sdd1 
mke2fs -t ext4 -O extents -F -j -i 16384 -L ARMDEBCHROOT    -m 2 /dev/sdd2 # 600K inodes, 2% root reserve
mke2fs -t ext4 -O extents -F -j -i 8192  -L ARMDEBCHROOT_R1 -m 5 /dev/sdd3 # reserved for /var and/or /home
mke2fs -t ext4 -O extents -F -j -i 8192  -L ARMDEBCHROOT_R2 -m 5 /dev/sdd4 # reserved for swap
tune2fs -c 20 -i 2m -e remount-ro /dev/sdd2 # set fsck requirements nobody will honor
tune2fs -c 20 -i 2m -e remount-ro /dev/sdd3 # and set the behaviour on errors
tune2fs -c 20 -i 2m -e remount-ro /dev/sdd4

mkdir /mnt1; mount /dev/sdd2 /mnt1
</pre>

<p  class=anno>(maybe consider to increase the journal size to  better
spread  writes; this works in case the journal is rolling and doesn't reset
to a fixed start of journal; not checked)</p>



<h4>Debootstrap</h4>

<p>Run  stage  1  still on the Linux Box and copy the results  to  the
chroot  filesystem.  Both  stable (squeeze) and testing  (wheezy)  are
suitable for use as chroot.</p>

<pre>
debootstrap --arch armel --foreign testing /chroots/sid-armel http://ftp.us.debian.org/debian
(cd /chroots/sid-armel &amp;&amp; cpio -pmdu /mnt1)
sync; sleep 2; umount /mnt1
mount | grep ...
</pre>

<p>Umount  and remove the sdcard from the card reader and reinsert  it
in the Note. Boot the Note. And further prepare the chroot.</p>

<pre>
umask 022 # (I had an umask of 011 from dropbear!?)
cd /
mkdir /x
mount /dev/block/mmcblk1p2 /x
mkdir /x/a
cd /x/a
ln -s mnt/sdcard i
ln -s mnt/sdcard sdcard
ln -s mnt/sdcard/external_sd e
ln -s data/local/tmp t
ln -s data/local/setup s
ln -s system/etc .
ln -s sys/kernel/debug d
ln -s data/local/root .
mkdir ./-p ../-p
chmod 444 ./-p ../-p
#
mkdir -p proc sys acct system data dev efs cache mnt 
mkdir -p mnt/.lfs mnt/sdcard mnt/usb mnt/obb mnt/asec mnt/app-cache
# I will skip some of the mounts here (asec, etc)
mkdir -p mnt/secure/asec
mount -orbind /sys sys
mount -obind /acct acct
mount -obind /data data
mount -obind /system system
mount -obind /cache cache
mount -orbind /mnt/sdcard mnt/sdcard
mount -orbind /dev dev
mount -orbind /app-cache app-cache
# we cannot bind anything rootfs
mkdir COPIED
( cd /; find bin config customkernel dbdata default.prop lib res sbin usr vendor | cpio -pmdu /x/a/COPIED )
ln -s COPIED/* .
#
cd /x
mv dev dev.old
ln -s a/* . 2&gt;/dev/null
# proc must be real and not a symlink
mkdir proc
mount -t proc proc proc  
</pre>

<p>With  the mounts and directories in place, enter the chroot for the
first time, run the second stage of debootstrap to install the initial
system,   and  update  the  system  to  the  current  version  in  the
repositories.</p>

<pre>
cd /x 
chroot /x

export PATH=/usr/bin:/usr/sbin:/bin:$PATH
export TERM=linux
export HOME=/root
export USER=root

# this requires a few minutes
/debootstrap/debootstrap --second-stage 

# undo the damage done by debootstrap, and restore some of the symlinks
cd /
rmdir sys 
rm -r dev.old; mv dev dev.old
ln -s a/* .
cd /etc
rm mtab;  ln -s /proc/mounts mtab
# android has no sane fstab, just vold.fstab
# shall we combine resolv.conf?
rm resolv.conf; ln -s /a/etc/resolv.conf .
rm hosts; ln -s /a/etc/hosts .
# shall we also use the android side passwd and groups? Not for now.

cd /
ln -s / x
# some apps may honor this and do not startup during installation
mv /x/usr/sbin/policy-rc.d /x/usr/sbin/policy-rc.d.ORIG # does not exist
echo "echo 'All rc.d operations denied by policy; >&amp;2; exit 101" &gt; /x/usr/sbin/policy-rc.d
mv /x/etc/apt/sources.list /x/etc/apt/sources.list.ORIG # debootstrap version is invalid
echo "deb     http://ftp.de.debian.org/debian testing main contrib non-free" &gt;&gt; /x/etc/apt/sources.list
echo "deb-src http://ftp.de.debian.org/debian testing main contrib non-free" &gt;&gt; /x/etc/apt/sources.list
# change the hostname away from name of the Linux box
echo note &gt; /etc/hostname

# another few minues
apt-get update
apt-get install debian-ports-archive-keyring
apt-get update
apt-get install build-essential
apt-get tightvncserver xtightvncviewer icewm xterm
apt-get mc tmux vim vim-scripts m4 rsync sshfs elinks mutt
apt-get lsb-languages lsb-languages-armel lsb-languages-noarch lsb-core


# a first backup of the initial chroot
cd /
find . -xdev | sort &gt; FIND.chroot
cat FIND.chroot | cpio -o -H crc &gt; /i/chroot-initial.cpio

# you may wish to install software for basic tasks like desktop or file serving; 
# requires more than just a few minutes, depending on your selection
tasksel

dpkg-reconfigure tzdata

# all package lines should start with ii (properly installed)
dpkg -l | grep -v '^ii'

# has aptitude any issues or problems (press 'g')
aptitude

aptitude clean
</pre>




<p>Notes</p>
<ul>
<li>run mount and check the mount options for the chroot filesystem: it
should be something along the lines of rw,noatime,barrier=1,data=ordered; otherwise 
change CHROOT.mount or use tune2fs to add default mount options.
<li>Android doesn't supply a working fsck for ext4, see system/xbin/CHROOT.fsck for an example work-around.
<li>if the bluez packages is still broken and insists on a running udevd, just remove 
   /var/lib/dpkg/info/bluez.postinst and run dpkg --configure --all.
<li>mono is not needed, furthermore there were some packaging errors. Uninstall with some effort: 
<i>aptitude install gnote; 
dpkg -i /var/cache/apt/archives/libglib2.0-cil_2.12.10-3_armel.deb;
dpkg -i /var/cache/apt/archives/libgtk2.0-cil_2.12.10-3_armel.deb;
aptitude purge libdbus-glib1.0-cil libdbus1.0-cil libgconf2.0-cil
 libglib2.0-cil libgmime2.4-cil libgtk2.0-cil tomboy libmono-addins-gui0.2-cil 
libmono-addins0.2-cil libmono-i18n-west4.0-cil libmono-i18n4.0-cil libmono-posix4.0-cil
 libmono-sharpzip4.84-cil libmono-system-configuration4.0-cil libmono-system-core4.0-cil
 libmono-system-drawing4.0-cil libmono-system4.0-cil mono-gac mono-runtime; 
aptitude purge mono-runtime libmono-system4.0-cil</i>
<li>on removing apps, run deborphan and consider uninstalling the listed files,
    then start aptitude and press 'g' and look if aptitude suggests additional
    removals from the previously automatically installed packages. Keep what you
    still use (e.g. press i/m) and continue to remove the rest.
<li>to add checksums of installed files (though not verifying permissions), install debsums
    and run debsums_init.
</ul>



<h4>Some customization</H4>

<-- -------------------------^^^ clean \/\/\/ borked ---------------------------------------------------------------- -->

<p> root profiles</p>

<p>ssh dial back</p>
cd ~/.ssh
ln -s /etc/ssh/ssh_host_rsa_key id_rsa
ln -s /etc/ssh/ssh_host_rsa_key.pub id_rsa.pub

(placing symlink x to CHROOT.run in /data/data/berserker.android.apps.sshdroid/dropbear)




append the pub key in sshdroid's home .ssh/authorized_keys


<p>a user account - adduser and 3003 (CONFIG_ANDROID_PARANOID_NETWORK)p>

 stay out of android user space!
edit /etc/login.def to 20000 instead of 1000 for UID_MIN, GID_MIN
edit /etc/adduser.conf similarly
invoke adduser <YOUR NAME>

append to /etc/group (and fix gshadow)
android1:x:1000
android2:x:1015
android_network:x:3003:YOUR_LOGNAME (and possibly all network-using daemon accounts as well)


<p>ssh-agent > ~/.ssh/env.note</p>

<p>mutt and the outside world</p>

<p>umlauts and locale</p>
# umlauts: within TERMIDE app: I don't care about them
# ssh and dropbear: OK, however deleting them requires deleting the char + once more a mangled one
# (probably utf8 remnant mistreated as latin1 (on deletion))
# after switching via TERMIDE script: not in bash; otherwise same effect as above
# --> we don't have utf8 locale in android at all
# ssh to chroot: # same as above. with LANG=C.UTF-8 LC_COLLATE=C the delete snafu stops.



stupid ram tricks - page cache, sysctl -w vm.min_free_kbytes=131072
/sbin/sysctl vm.drop_caches=3

<p>lxc: unsupported (maybe just too old; but this also requires Android side bridging, which may be unsupported)</p>


apt-pinning mixed mode as seen with firefox - see etc/apt/sources-list from examples.
apt-get install <package>/unstable    
apt-get -t unstable install <package> # prefer unstable for resolution






<H4>Overview of Services and an Automation Example</h4>

<p>Some applications require a running dbus: <i>/etc/init.d/dbus start</i></p>

<p>Terminal  multiplexing:  screen  is  broken and  hangs  on  detach,
however tmux is working properly. See /root/.tmux.conf for setting
the command key to CTRL-a like with screen.</p>

<p>Virtualization,  e.g. lxc: mostly unsupported (bridging might  also
be unsupported, depending on the kernel).</p>

<p>Basic  cron  services  are  problematic, as  sleep  is  unreliable.
abin/CRON* offers an example setup to to cope with this situation. The
15min  job  contains  code to catch missed runs of  the  slower  shell
scripts  and  tries to resynchronize them with their  original  window
when  delayed.  All  you  need to do is  invoking  x  /abin/CRON.15min
remotely  or with <i>tasker</i> or from multiple invocation sources at
once  (the  jobs  maintain suitable locking). This  example  might  be
extended  with anacron and more of the actual cron jobs configured  in
/etc.  The abin/CRON.15min script is currently run by remote root cron
every 15 minutes.</p>

<p>In  my  case  I've instead added a repeated short  period  WAKELOCK
invocation  to  the root cronjob on my Linux box. Thus  sleep  becomes
reliable  in  my home WLAN and the ordinary cron (if started) can  run
normally  during  the night. However this also implies that not  using
the CPU by sleeping now costs extra battery, as the Note can no longer
do a quick automatic suspend-to-RAM.</p>

<p>Monitoring:  the  example  abin/CHECK  offers  a  basic  monitoring
script,  which can be run by ssh and evaluated remotely (see the  root
cronjob and watch_delta; run every 15 minutes).</p>

<p>Mail  notification  and forwarding: Without out setup exim4  places
all  email  in  the  /var/mail/mail  spool  file.  abin/CHECK  reports
available  mail, as should TOP. Again have a look at the root  cronjob
file  for  an example to forward this mail to accounts on  the  remote
Linux box (run every 15 minutes). </p>

<p>For   backup   and  synchronization,  revisit  the   example   file
xfer_backup.wrapper.anuurn.local and the nightly backup job invoked by
remote  root cron. Besides running the list-based rsync, it also  runs
home/jakobi/bin/ct_note.update-copies                              and
home/jakobi/bin/ct_note.update-unison.  The  first clones a subset  of
the  my  home  directory onto Note, the second synchronizes  a  folder
tree,  with one layer also following symlinks, both only run when  the
chroot  is  mounted.  As the Ubuntu 10.4 version was  too  ancient,  I
installed  a  new  build in /usr/local/bin on the  Linux  box.  Remote
invocation  is  as  simple as <i>DISPLAY= unison  /data/unison  -batch
-auto -servercmd "x unison" ssh://note//data/unison</i></p>

<p>Using  sshd:  I'm  still using <i>sshdroid</i>'s  dropbear  as  the
primary  ssh daemon, dealing with backup traffic, and everything.  The
chroot  from  the linux box by running <i>ssh root@note x  COMMAND</i>
(e.g.  done  by  unison;  rsync dislikes the space  in  'remote  rsync
command   names'   and  requires  the  chroot-rsync  dummy   file   in
sshdroid/dropbear).   If   you  need  a  real  sshd  without   similar
work-around,  just  run  <i>sshd  -p PORT  &amp;</i>  in  the  chroot,
possibly also stopping sshdroid. If you really want to, you can add it
to  system/etc/init.d/S99zz_compact_jobs  to  start  at  boot  of  the
Note.</p>

<p>Accessing remote filesystems: Have a look at the example abin/SSHFS
containing simple mount/umount commands to permit access to files on a
remote Linux box. This requires the fuse sshfs package and even offers
access  to anything mounted on the remote Linux box. SSHFS is intended
to  also  deal with SMB, and NFS (if the kernel permits), but this  is
not yet tested.</p>

<p>File serving: Use the usual culprits of ftp, apache and samba as on
any  Linux  box. Don't forget to edit and rerun FW on if you  need  to
open ports in the firewall.</p>

<p>Notes</p>
<ul>
<li>in  the  long  run, this  chroot  setup  is  still  not
comparable  to a native install, that can replace and update the Linux
kernel  as  part of the normal package maintenance. We still  have  to
rely  on  availability of stock kernels as part of the custom ROM,  as
it's  unlikely that some of the device blobs will be availble with new
kernels.  Furthermore,  vulnerabilities of the outside  Android  still
apply  and  will  only get worse when the device is obsoleted  by  the
maker  (at least Samsung doesn't do this before release to the market,
like some other makers).
<li>a newer architecture called <b>armhf</b> is being in the works at 
DEBIAN and Ubuntu, which introduces support for more modern CPU features 
and improves FPU support. However the
repository mentioned in the article on armhf failed already in stage
one of debootstrap in early January. This should prove interesting 
in the medium term. When it's ready, just replace <i>armel</i> with
<i>armhf</i>. (Check the release note and check with Google - it might even be 
possible to just change architectures in sources-list on an uptodate 
armel setup and reinstall (all) DEBIAN packages for use of armhf without
starting over with debootstrap and an empty directory).
<li>swap would be a good idea to add with a suitable swappiness  setting
to reserve swap as a last resort, as a notifier-by-pain to delay the 
 out-of-memory-killer (though I  didn't meet oom during any tests 
including X11 and LibreOffice).  I'd advise to change swappiness to
make the kernel prefer RAM to swap as long as possible: cheap flash may
also have a questionable flash translation layer (if at all), and swap with
randomly distributed write hotspots is the worst possible load to balance, 
way worse than FAT (one hotspot at the beginning), ext4 with an ordinary 
Linux install (with or without journal) or database files, with database
transaction logs being the most harmless use of all).
</ul>

<p><b>Summary:</b>  By  now we have a DEBIAN chroot and can access  it
from   the   Android  shell  interactively  or  as  part  of  a   pipe
(system/xbin/CHROOT.run  aka  x). You are also able to  access  remote
files  using  everything  but  NFS (see the  abin/SSHFS  example).  We
extended the remote automation with limited email checking, monitoring
and folder synchronization.</p>

<!-- ------------------------------------------------------------------------------------- -->
<hr><a href="#toc">(table of contents)</a><hr>
<a name=vnc></a>
<H3>Desktop and X11</H3>


<pre>


The  final  step is running a local X11 Desktop on the Note,  using
the  chroot's vncserver or Xvnc (market: Xvnc). To access, either  use
the local display of the Note or any PC with a vncviewer.

This  setup  is  enough  for  normal  LibreOffice  text
editing,   programming  or  some  light  web  browsing  (firefox9  and
chromium-browser  fail,  iceweasel/firefox  3.5 and  the  webkit/gecko
based  browsers  work), even without swap: I've usually  beyond  350MB
free  (free+buffers+cache) before starting X, which is enough for X11,
some xterms, firefox and LibreOffice.

Q: consider some encrypted loop mount ???

My  suspicions  on being very careful wrt using swap: SSD should  have
flash  translation layers (if cheaper flash actually has that at all):
A FAT fielsystem is simle (only the first few blocks are rewritten all
the  time). Database transaction logs are even simpler (all blocks get
rewritten  in sequence, so "wear and tear" is balanced) - both  permit
trivial  flash translation layers, or actually coping without any. Now
swap  and filesystem journals are differing: rist select a semi-random
set of blocks, and then rewrite them all the time.

Suggestion:  enable  swap  with  a very  stringent  swappiness  value;
despite  speed and quality differences, place swap (if at all) on  the
external sdcard, and only activate it when required.



the frequent firmware updates of quality vendors for all early ssd shows the severity of the issues wrt Flash.

wm and gnome/kde/...
browsers incl firefox  (only 3.5)
libreoffice

fails: firefox>3.5, chromium-browser (shared-memory)

pasting urxvt/ ubuntu issue to require adding xsel -op|xsel -ip about 0.6 seconds after the copying to buffer
in autocutsel???


notes:



</pre>

<p><b>Summary:</b> This concludes the series and by now you can use an
arbitrary  PC's  vncviewer or putty/ssh setup to connect to your  NOTE
and work locally on your Note in addition to using the Note to copy or
serve  files  to  the  PC. Excluding the size of  the  display,  we've
implemented most of the capabilities of newer tablets as well as those
of laptops on the Note.</p>

<p>As  you  no longer lug around your heavy laptop all the time,  it's
time to consider taking up some more joyful sports.</p>




<!-- ------------------------------------------------------------------------------------- -->
<hr><a href="#toc">(table of contents)</a><hr>
<p>Back to the <a href="index.html">Android Section Overview</a>.</p>

<hr>
<p class=anno>
<a href="http://jakobi.github.com/">HOME</a>                                          &nbsp;|&nbsp; 
<a href="http://github.com/jakobi/">GIT Overview</a>          &nbsp;|&nbsp;
Script-Archive:
<a href="/script-archive-doc/">(docs)</a> : 
<a href="http://wiki.github.com/jakobi/script-archive/">(wiki)</a> : 
<a href="http://github.com/jakobi/script-archive">(git)</a>    &nbsp;|&nbsp;
Android:
<a href="http://jakobi.github.com/android-section/">(articles)</a> 
<a href="http://github.com/jakobi/script-archive/tree/master/android">(files)</a> &nbsp;|&nbsp;
...
</p>

<p class=anno>jakobi(at)acm.org, 2012-01 - 2012-02</p>

</BODY>
</HTML>
